<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-diy.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-diy.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-diy.png"><link rel="mask-icon" href="/images/logo-diy.svg" color="#222"><meta name="baidu-site-verification" content="y1cfESbTt9nd3LsA"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-flash.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"githubwyb.github.io",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!0,color:"#ff0000",save:"auto"},fancybox:!1,mediumzoom:!0,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="一、前言123PS D:\work\src\local\cpp\openssl\1.1.1&gt; .\apps\openssl.exeOpenSSL&gt; versionOpenSSL 1.1.1k  25 Mar 2021  1. 下载 源码下载: https:&#x2F;&#x2F;www.openssl.org&#x2F;source&#x2F; github: https:&#x2F;&#x2F;github.com&#x2F;openssl&#x2F;opens"><meta property="og:type" content="article"><meta property="og:title" content="openssl学习记录"><meta property="og:url" content="https://githubwyb.github.io/blogs/2021-07-28-openssl/index.html"><meta property="og:site_name" content="技术的路上奔跑"><meta property="og:description" content="一、前言123PS D:\work\src\local\cpp\openssl\1.1.1&gt; .\apps\openssl.exeOpenSSL&gt; versionOpenSSL 1.1.1k  25 Mar 2021  1. 下载 源码下载: https:&#x2F;&#x2F;www.openssl.org&#x2F;source&#x2F; github: https:&#x2F;&#x2F;github.com&#x2F;openssl&#x2F;opens"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://githubwyb.github.io/blogs/2021-07-28-openssl/2022-01-24-01.png"><meta property="og:image" content="https://githubwyb.github.io/blogs/2021-07-28-openssl/2023-03-24-04.png"><meta property="og:image" content="https://githubwyb.github.io/blogs/2021-07-28-openssl/2023-03-21-02.png"><meta property="og:image" content="https://githubwyb.github.io/blogs/2021-07-28-openssl/2023-03-24-03.png"><meta property="og:image" content="https://githubwyb.github.io/2023-06-19-01.png"><meta property="og:image" content="https://githubwyb.github.io/2023-07-12-01.png"><meta property="article:published_time" content="2021-07-28T03:42:59.000Z"><meta property="article:modified_time" content="2023-12-20T03:33:55.000Z"><meta property="article:author" content="王钰博"><meta property="article:tag" content="网络"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://githubwyb.github.io/blogs/2021-07-28-openssl/2022-01-24-01.png"><link rel="canonical" href="https://githubwyb.github.io/blogs/2021-07-28-openssl/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>openssl学习记录 | 技术的路上奔跑</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">技术的路上奔跑</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">入门</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/Githubwyb" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://githubwyb.github.io/blogs/2021-07-28-openssl/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/12.jpg"><meta itemprop="name" content="王钰博"><meta itemprop="description" content="个人博客"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="技术的路上奔跑"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">openssl学习记录</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-07-28 11:42:59" itemprop="dateCreated datePublished" datetime="2021-07-28T11:42:59+08:00">2021-07-28</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2023-12-20 11:33:55" itemprop="dateModified" datetime="2023-12-20T11:33:55+08:00">2023-12-20</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Program/" itemprop="url" rel="index"><span itemprop="name">Program</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Program/C-C/" itemprop="url" rel="index"><span itemprop="name">C/C++</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/blogs/2021-07-28-openssl/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/blogs/2021-07-28-openssl/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>60k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>54 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS D:\work\src\local\cpp\openssl\1.1.1&gt; .\apps\openssl.exe</span><br><span class="line">OpenSSL&gt; version</span><br><span class="line">OpenSSL 1.1.1k  25 Mar 2021</span><br></pre></td></tr></table></figure><h2 id="1-下载"><a href="#1-下载" class="headerlink" title="1. 下载"></a>1. 下载</h2><ul><li>源码下载: <a target="_blank" rel="noopener" href="https://www.openssl.org/source/">https://www.openssl.org/source/</a></li><li>github: <a target="_blank" rel="noopener" href="https://github.com/openssl/openssl">https://github.com/openssl/openssl</a></li><li>二进制: <a target="_blank" rel="noopener" href="https://wiki.openssl.org/index.php/Binaries">https://wiki.openssl.org/index.php/Binaries</a></li></ul><h2 id="2-编译"><a href="#2-编译" class="headerlink" title="2. 编译"></a>2. 编译</h2><h3 id="2-1-二进制编译"><a href="#2-1-二进制编译" class="headerlink" title="2.1. 二进制编译"></a>2.1. 二进制编译</h3><h4 id="1-linux"><a href="#1-linux" class="headerlink" title="1) linux"></a>1) linux</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--debug 编译带符号</span></span><br><span class="line">=&gt; ./config --debug --prefix=/path/to/install</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译</span></span><br><span class="line">=&gt; make -j8</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line">=&gt; make install</span><br></pre></td></tr></table></figure><h3 id="2-2-引擎编译"><a href="#2-2-引擎编译" class="headerlink" title="2.2. 引擎编译"></a>2.2. 引擎编译</h3><h1 id="二、命令"><a href="#二、命令" class="headerlink" title="二、命令"></a>二、命令</h1><h2 id="1-一些基本用法"><a href="#1-一些基本用法" class="headerlink" title="1. 一些基本用法"></a>1. 一些基本用法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">枚举支持的加密套件</span></span><br><span class="line">=&gt; openssl ciphers -V | column -t</span><br><span class="line">0x13,0x02  -  TLS_AES_256_GCM_SHA384         TLSv1.3  Kx=any       Au=any    Enc=AESGCM(256)             Mac=AEAD</span><br><span class="line">0x13,0x03  -  TLS_CHACHA20_POLY1305_SHA256   TLSv1.3  Kx=any       Au=any    Enc=CHACHA20/POLY1305(256)  Mac=AEAD</span><br><span class="line">0x13,0x01  -  TLS_AES_128_GCM_SHA256         TLSv1.3  Kx=any       Au=any    Enc=AESGCM(128)             Mac=AEAD</span><br><span class="line">0xC0,0x2C  -  ECDHE-ECDSA-AES256-GCM-SHA384  TLSv1.2  Kx=ECDH      Au=ECDSA  Enc=AESGCM(256)             Mac=AEAD</span><br><span class="line">0xC0,0x30  -  ECDHE-RSA-AES256-GCM-SHA384    TLSv1.2  Kx=ECDH      Au=RSA    Enc=AESGCM(256)             Mac=AEAD</span><br><span class="line">0x00,0x9F  -  DHE-RSA-AES256-GCM-SHA384      TLSv1.2  Kx=DH        Au=RSA    Enc=AESGCM(256)             Mac=AEAD</span><br><span class="line">0xCC,0xA9  -  ECDHE-ECDSA-CHACHA20-POLY1305  TLSv1.2  Kx=ECDH      Au=ECDSA  Enc=CHACHA20/POLY1305(256)  Mac=AEAD</span><br><span class="line">0xCC,0xA8  -  ECDHE-RSA-CHACHA20-POLY1305    TLSv1.2  Kx=ECDH      Au=RSA    Enc=CHACHA20/POLY1305(256)  Mac=AEAD</span><br><span class="line">0xCC,0xAA  -  DHE-RSA-CHACHA20-POLY1305      TLSv1.2  Kx=DH        Au=RSA    Enc=CHACHA20/POLY1305(256)  Mac=AEAD</span><br><span class="line">0xC0,0x2B  -  ECDHE-ECDSA-AES128-GCM-SHA256  TLSv1.2  Kx=ECDH      Au=ECDSA  Enc=AESGCM(128)             Mac=AEAD</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="1-1-国密openssl命令"><a href="#1-1-国密openssl命令" class="headerlink" title="1.1. 国密openssl命令"></a>1.1. 国密openssl命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">列举支持的椭圆曲线</span></span><br><span class="line">openssl_gm ecparam -list_curves</span><br></pre></td></tr></table></figure><h2 id="2-证书"><a href="#2-证书" class="headerlink" title="2. 证书"></a>2. 证书</h2><h3 id="1-1-颁发证书"><a href="#1-1-颁发证书" class="headerlink" title="1.1. 颁发证书"></a>1.1. 颁发证书</h3><h4 id="1-国际密码标准（普密）"><a href="#1-国际密码标准（普密）" class="headerlink" title="(1) 国际密码标准（普密）"></a>(1) 国际密码标准（普密）</h4><p><strong>1. 颁发证书需要先生成一个颁发机构，也就是CA</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新建目录防止混乱</span></span><br><span class="line">mkdir -p ssl_diy/private &amp;&amp; cd ssl_diy</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成ca的私钥</span></span><br><span class="line">openssl genrsa -out private/cakey.pem 2048</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据key生成CA的证书文件</span></span><br><span class="line">openssl req -new -x509 -days 3650 -key private/cakey.pem -out cacert.pem</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将有一些配置需要填写，可以随意填写，因为是自颁发</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Country Name (2 letter code) [AU]: 国家名，自然CN</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">State or Province Name (full name) [Some-State]: 省份名称，比如Hunan</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Locality Name (eg, city) []: 城市名称，比如changsha</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Organization Name (eg, company) [Internet Widgits Pty Ltd]: 公司名称</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Organizational Unit Name (eg, section) []: 部门名称</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Common Name (eg, YOUR name) []: 颁发者的名字</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Email Address []: 邮件地址</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以直接使用-subj指定subject</span></span><br><span class="line">openssl req -new -x509 -key private/cakey.pem -out cacert.pem -subj &quot;/C=CN/ST=Beijing/L=Haidian/O=Datang/OU=SDT/OU=abc/CN=Shixun/emailAddress=dongzy08@qq.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pem转crt格式</span></span><br><span class="line">openssl x509 -outform der -in cacert.pem -out cacert.crt</span><br></pre></td></tr></table></figure><p><strong>2. 生成证书</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######## 生成证书 ###########</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同样生成私钥key</span></span><br><span class="line">openssl genrsa -out domain.key 2048</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">根据key生成证书请求文件</span></span><br><span class="line">openssl req -new -key domain.key -out domain.csr</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将有一些配置需要填写，可以随意填写，因为是自颁发</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Country Name (2 letter code) [AU]: 国家名，自然CN</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">State or Province Name (full name) [Some-State]: 省份名称，比如Hunan</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Locality Name (eg, city) []: 城市名称，比如changsha</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Organization Name (eg, company) [Internet Widgits Pty Ltd]: 公司名称</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Organizational Unit Name (eg, section) []: 部门名称</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Common Name (eg, server FQDN or YOUR name) []: 填写网站的域名</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Email Address []: 邮件地址</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以直接使用-subj指定subject</span></span><br><span class="line">openssl req -new -key domain.key -out domain.csr -subj &quot;/C=CN/ST=Beijing/L=Haidian/O=Datang/OU=SDT/OU=abc/CN=Shixun/emailAddress=dongzy08@qq.com&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######## 使用ca给证书签名，签了名的证书才是真正的证书 ###########</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签名前需要有几个准备文件</span></span><br><span class="line">mkdir -p demoCA/newcerts</span><br><span class="line">touch demoCA/index.txt</span><br><span class="line">echo 01 &gt; demoCA/serial</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签名，可以自定义有效天数-days</span></span><br><span class="line">openssl ca -in domain.csr -cert cacert.pem -keyfile private/cakey.pem -days 365 -out domain.crt</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成p12，需要设置密码</span></span><br><span class="line">openssl pkcs12 -export -out domain.p12 -inkey domain.key -in domain.crt</span><br></pre></td></tr></table></figure><h4 id="2-中国密码标准（国密）"><a href="#2-中国密码标准（国密）" class="headerlink" title="(2) 中国密码标准（国密）"></a>(2) 中国密码标准（国密）</h4><p><strong>0. 准备工作</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ssl_diy/private</span><br><span class="line">cd ssl_diy</span><br></pre></td></tr></table></figure><p><strong>1. 生成用户证书</strong></p><ol><li>根据椭圆曲线生成密钥</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl_gm ecparam -genkey -name SM2 -out private/root-cakey.pem</span><br></pre></td></tr></table></figure><ul><li>生成的密钥内容如下</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN EC PARAMETERS-----</span><br><span class="line">BggqgRzPVQGCLQ==</span><br><span class="line">-----END EC PARAMETERS-----</span><br><span class="line">-----BEGIN EC PRIVATE KEY-----</span><br><span class="line">MHcCAQEEIPS25CUNA9sedtqmVHAkIBhknFUAREy5+eEfg/vkX30noAoGCCqBHM9V</span><br><span class="line">AYItoUQDQgAEnnSjGFJ3LG1qA7wYGpnRxr6palpBtuw4yToNW7QRZKz12s438i1G</span><br><span class="line">Dqxf97ZcfeI6pAxb+e4TOSLu7tIt+wFyng==</span><br><span class="line">-----END EC PRIVATE KEY-----</span><br></pre></td></tr></table></figure><h4 id="3-生成带拓展字段的证书"><a href="#3-生成带拓展字段的证书" class="headerlink" title="(3) 生成带拓展字段的证书"></a>(3) 生成带拓展字段的证书</h4><ul><li>需要拷贝一份<code>/etc/ssl/openssl.cnf</code>文件到自己的目录下</li><li>修改里面的字段，添加下面的字段</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[ v3_req ]</span></span><br><span class="line"><span class="comment"># 添加下面语句</span></span><br><span class="line"><span class="attr">subjectAltName</span> = @alt_names</span><br><span class="line">...</span><br><span class="line"><span class="comment"># 添加下面块，DNS加几个自己决定</span></span><br><span class="line"><span class="section">[ alt_names ]</span></span><br><span class="line"><span class="attr">DNS.1</span> = www.test.com</span><br><span class="line"><span class="attr">DNS.2</span> = *.aaa.com</span><br></pre></td></tr></table></figure><ul><li>然后在生成证书（非生成CA）的命令中加上<code>-config /path/to/openssl.cnf</code></li><li>签名命令中加上<code>-config /path/to/openssl.cnf -extensions v3_req</code></li></ul><h3 id="1-2-证书转换"><a href="#1-2-证书转换" class="headerlink" title="1.2. 证书转换"></a>1.2. 证书转换</h3><p><strong>csr（Certificate Signing Request）</strong></p><ul><li>通常为证书请求，PEM格式编码，包含证书请求信息和公钥，通常是没有签名的证书</li></ul><p><strong>crt&#x2F;cer（Certificate）</strong></p><ul><li>通常为被ca机构签名后的证书格式，包含证书本身的信息（证书和公钥）和证书颁发机构的信息</li><li>crt一般在linux上使用，cer一般在windows上使用</li><li>两种格式都可以使用pem编码或者der编码</li></ul><p><strong>pem（Privacy-Enhanced Mail）</strong></p><ul><li>pem是储存证书和密钥的一种格式，一般是base64编码，以<code>-----BEGIN CERTIFICATE-----</code>和<code>-----END CERTIFICATE-----</code>包裹</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pem格式转der格式</span></span><br><span class="line">openssl x509 -outform der -in cert.pem -out cert.der</span><br></pre></td></tr></table></figure><p><strong>der（Distinguished Encoding Rules）</strong></p><ul><li>der是一种二进制格式，通常用于在网络上传输证书。cer（Certificate）是DER编码的X.509证书的扩展名，通常用于Windows操作系统中</li><li>der不能使用<code>CERTIFICATE REQUEST</code>的pem转换，需要使用<code>CERTIFICATE</code>转换，也就是需要ca签名后的证书</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">der格式转pem格式</span></span><br><span class="line">openssl x509 -inform der -in cert.der -out cert.pem</span><br></pre></td></tr></table></figure><p><strong>p12</strong></p><ul><li>p12是证书和私钥结合的证书，一般作为设备证书导入使用或者导入为浏览器证书做证书认证使用</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######### 解开p12证书 ##########</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">只要证书，需要密码</span></span><br><span class="line">openssl pkcs12 -clcerts -nokeys -in cert.p12 -out cert.pem</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">只要私钥</span></span><br><span class="line">openssl pkcs12 -nocerts -nodes -in cert.p12 -out key.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######### 生成p12证书 ##########</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要私钥+证书生成，需要设置密码</span></span><br><span class="line">openssl pkcs12 -export -out domain.p12 -inkey domain.key -in domain.crt</span><br></pre></td></tr></table></figure><h3 id="1-3-验证证书"><a href="#1-3-验证证书" class="headerlink" title="1.3. 验证证书"></a>1.3. 验证证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用ca根证书校验客户端证书</span></span><br><span class="line">openssl verify -CAfile root.crt client.pem</span><br></pre></td></tr></table></figure><h3 id="1-4-查看证书"><a href="#1-4-查看证书" class="headerlink" title="1.4. 查看证书"></a>1.4. 查看证书</h3><ul><li>oid的对照关系可以看<code>node-forge/lib/oids.js</code></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印证书内容，下面命令传入的是ascii字符版证书</span></span><br><span class="line">openssl x509 -in cert.pem -noout -text</span><br></pre></td></tr></table></figure><h2 id="3-客户端-openssl-s-client"><a href="#3-客户端-openssl-s-client" class="headerlink" title="3. 客户端 openssl s_client"></a>3. 客户端 <code>openssl s_client</code></h2><h3 id="3-1-选项"><a href="#3-1-选项" class="headerlink" title="3.1. 选项"></a>3.1. 选项</h3><ul><li><code>-engine &lt;name&gt;</code>: 使用引擎，给一些使用硬件加密的代码使用</li><li><code>-ssl_client_engine &lt;name&gt;</code>: 使用引擎给客户端需要证书操作时</li><li><code>-connect &lt;ip:port&gt;</code>: 连接地址，仅支持ip+端口，不支持url</li><li><code>-msg</code>: 显示协议相关的消息体</li><li><code>-state</code>: 显示当前ssl的阶段</li><li><code>-debug</code>: 额外显示一些输出</li><li><code>-tls1_1</code>: 使用tlsv1.1进行通信</li><li><code>-cipher &lt;ciphers&gt;</code>: 指定tlsv1.2及以下的套件列表</li><li><code>-ciphersuites &lt;ciphers&gt;</code>: 指定tlsv1.3套件列表</li><li><code>-key &lt;keyPath&gt;</code>: 如果证书<code>-cert</code>没有带key，需要指定私钥</li><li><code>-cert &lt;certPath&gt;</code>: 证书，pem格式</li><li><code>-servername &lt;serverName&gt;</code>: 添加tls的extension字段<code>server_name</code></li><li><code>-keylogfile &lt;keyfile&gt;</code>: 将预主密钥保存到文件</li></ul><h3 id="3-2-示例用法"><a href="#3-2-示例用法" class="headerlink" title="3.2. 示例用法"></a>3.2. 示例用法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-connect 127.0.0.1:7777   连接127.0.0.1:7777</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-cipher RSA               使用RSA密钥交换算法相关的算法套件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-debug                    开启调试日志</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-keylogfile test.log      将预主密钥保存到test.log</span></span><br><span class="line">openssl s_client -connect 127.0.0.1:7777 -cipher RSA -debug -keylogfile test.log</span><br></pre></td></tr></table></figure><h2 id="4-服务端-openssl-s-server"><a href="#4-服务端-openssl-s-server" class="headerlink" title="4. 服务端 openssl s_server"></a>4. 服务端 <code>openssl s_server</code></h2><ul><li><code>-accept &lt;port&gt;</code>: 监听端口</li><li><code>-tls1_1</code>: 只使用tlsv1.1</li><li><code>-cipher &lt;ciphers&gt;</code>: 指定tlsv1.2及以下的套件列表</li><li><code>-ciphersuites &lt;ciphers&gt;</code>: 指定tlsv1.3套件列表</li><li><code>-state</code>: 显示当前ssl的阶段</li><li><code>-CAfile &lt;caPath&gt;</code>: ca根证书路径，用于校验对端证书，pem格式</li><li><code>-key &lt;keyPath&gt;</code>: 如果证书<code>-cert</code>没有带key，需要指定私钥</li><li><code>-cert &lt;certPath&gt;</code>: 证书，pem格式</li><li><code>-verify int</code>: 开启校验对端证书</li><li><code>-Verify int</code>: 强制要求对端有证书，并开启校验</li><li><code>-verify_return_error</code>: 默认情况下，上面的而校验失败了只会打印日志后继续，加了此选项才会断开连接</li><li><code>-WWW</code>: 当前目录作为根目录进行http服务，最简单的http服务，必须输入全路径才能处理包括index.html</li></ul><h3 id="4-2-示例用法"><a href="#4-2-示例用法" class="headerlink" title="4.2. 示例用法"></a>4.2. 示例用法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-accept 7777      监听7777端口</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-tls1_2           使用tlsv1.2及以下加密套件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-state            显示ssl握手阶段</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-debug            显示debug日志</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-key domain.key   证书私钥</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-cert domain.crt  证书和公钥信息</span></span><br><span class="line">openssl s_server -accept 7777 -tls1_2 -state -debug -key domain.key -cert domain.crt</span><br></pre></td></tr></table></figure><h1 id="三、openssl库"><a href="#三、openssl库" class="headerlink" title="三、openssl库"></a>三、openssl库</h1><h2 id="1-引擎开发指南"><a href="#1-引擎开发指南" class="headerlink" title="1. 引擎开发指南"></a>1. 引擎开发指南</h2><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1. 简介"></a>1.1. 简介</h3><ul><li>引擎库是openssl给一些硬件设备提供的一个标准化开发接口，可以通过编写一些硬件接口对接openssl实现ssl过程中使用硬件进行加解密等操作</li><li>一般引擎库再windows上放置位置为<code>C:\Program Files (x86)\OpenSSL\lib\engines-1_1\xxx.dll</code>文件，加载时会根据id找同名dll文件</li><li>实现上对于企业用户，使用引擎库可以作为ukey来证书认证或国密加密认证等</li><li>ukey不管是普密还是国密，都是无法导出私钥的，证书的认证流程需要使用私钥对证书进行签名，再发送给服务端进行解析，所以引擎库里面不仅需要导出证书接口，还需要实现证书的签名接口，使用ukey的签名接口进行签名</li><li>skf转openssl结构体参考仓库: <a target="_blank" rel="noopener" href="https://github.com/guanzhi/GmSSL">https://github.com/guanzhi/GmSSL</a></li></ul><h3 id="1-2-基础接口"><a href="#1-2-基础接口" class="headerlink" title="1.2. 基础接口"></a>1.2. 基础接口</h3><ul><li>加载引擎必须要定义的下面几个函数</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/******************** 这个函数是引擎设置的最基础的函数 ********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Constants used when creating the ENGINE */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* engine_id = <span class="string">&quot;skf&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Prepare the ENGINE structure for registration */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">skf_bind_helper</span><span class="params">(ENGINE* e)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_DEBUG</span>(Tag, <span class="string">&quot;skf_bind_helper&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set skf rsa engine method, use default method and diy some function</span></span><br><span class="line">    <span class="keyword">if</span> ((skf_rsa_method = <span class="built_in">RSA_meth_dup</span>(<span class="built_in">RSA_get_default_method</span>())) == <span class="literal">NULL</span> ||</span><br><span class="line">        <span class="comment">// 私钥加密函数</span></span><br><span class="line">        <span class="built_in">RSA_meth_set_priv_enc</span>(skf_rsa_method, skf_rsa_priv_enc) == <span class="number">0</span> ||</span><br><span class="line">        <span class="built_in">RSA_meth_set_sign</span>(skf_rsa_method, my_sign) == <span class="number">0</span> ||</span><br><span class="line">        <span class="built_in">RSA_meth_set_verify</span>(skf_rsa_method, my_verify) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ENGINE_set_id</span>(e, engine_id) ||                     <span class="comment">// 引擎id</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_name</span>(e, engine_name) ||                 <span class="comment">// 引擎名字</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_init_function</span>(e, engine_init) ||        <span class="comment">// 初始化函数，握手前调用</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_finish_function</span>(e, engine_finish) ||    <span class="comment">// 结束函数，连接完成不再需要引擎时调用</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_destroy_function</span>(e, engine_destroy) ||  <span class="comment">// 销毁函数，结束时调用，只会被调用一次</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_RSA</span>(e, skf_rsa_method) ||               <span class="comment">// 设置rsa算法结构体</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_EC</span>(e, &amp;skf_ecc_meth) ||                 <span class="comment">// 设置rsa算法结构体</span></span><br><span class="line">        <span class="comment">// if not set, sdf will load by default if possible</span></span><br><span class="line">        <span class="comment">// !ENGINE_set_flags(e, ENGINE_FLAGS_NO_REGISTER_ALL) ||</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_load_ssl_client_cert_function</span>(e, skf_load_ssl_client_cert)  <span class="comment">// 设置客户端证书加载函数</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/****************** 下面是给openssl库的标准接口，必须定义的 ********************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* This stuff is needed if this ENGINE is being compiled into a self-contained</span></span><br><span class="line"><span class="comment"> * shared-library. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> OPENSSL_NO_DYNAMIC_ENGINE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/engine.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">bind_helper</span><span class="params">(ENGINE* e, <span class="type">const</span> <span class="type">char</span>* id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &amp;&amp; (<span class="built_in">strcmp</span>(id, engine_id) != <span class="number">0</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">skf_bind_helper</span>(e)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">IMPLEMENT_DYNAMIC_CHECK_FN</span>()</span><br><span class="line"><span class="built_in">IMPLEMENT_DYNAMIC_BIND_FN</span>(bind_helper)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="function"><span class="type">static</span> ENGINE* <span class="title">engine_skf</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    ENGINE* eng = <span class="built_in">ENGINE_new</span>();</span><br><span class="line">    <span class="keyword">if</span> (!eng) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">skf_bind_helper</span>(eng)) &#123;</span><br><span class="line">        <span class="built_in">ENGINE_free</span>(eng);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> eng;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">engine_load_skf_int</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    ENGINE* toadd = <span class="built_in">engine_skf</span>();</span><br><span class="line">    <span class="keyword">if</span> (!toadd) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">ENGINE_add</span>(toadd);</span><br><span class="line">    <span class="built_in">ENGINE_free</span>(toadd);</span><br><span class="line">    <span class="built_in">ERR_clear_error</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* OPENSSL_NO_DYNAMIC_ENGINE */</span></span></span><br></pre></td></tr></table></figure><ul><li>编译出来的引擎库名字和设置中的<code>engine_id</code>要一致</li></ul><h3 id="1-3-编译"><a href="#1-3-编译" class="headerlink" title="1.3. 编译"></a>1.3. 编译</h3><ul><li>在openssl的源码根目录下新建一个文件夹放引擎代码，就假设是<code>my-engine</code></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">my-engine</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── ecc.cpp</span><br><span class="line">├── ecc.h</span><br><span class="line">├── e_skf.cpp</span><br><span class="line">├── log.hpp</span><br><span class="line">└── Makefile</span><br></pre></td></tr></table></figure><h4 id="makefile"><a href="#makefile" class="headerlink" title="makefile"></a>makefile</h4><ul><li>makefile暂时只支持linux的gcc编译</li></ul><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">CC = gcc</span><br><span class="line">CXX = g++</span><br><span class="line">CFLAGS = -g -fPIC -Wall -Werror -Wshadow -Wno-unused-function -std=c11</span><br><span class="line">CXXFLAGS = -g -fPIC -Wall -Wshadow -Wno-unused-function -std=c++14</span><br><span class="line">LFLAGS = -shared -fPIC</span><br><span class="line"></span><br><span class="line"><span class="comment">#要编译的目标</span></span><br><span class="line">TARGET = skf.so</span><br><span class="line"><span class="comment">#源文件路径，跟makefile文件同目录不用填，目录使用/结束</span></span><br><span class="line">SRCDIR = ./</span><br><span class="line"><span class="comment">#编译中间文件路径，跟SRCDIR目录不用填，目录使用/结束</span></span><br><span class="line">OBJDIR =</span><br><span class="line"><span class="comment">#链接库路径，带上-L，-L../</span></span><br><span class="line">LIB_DIRS = -L../</span><br><span class="line"><span class="comment">#链接库名，带上-l，-lsvpn 静态库填写绝对路径</span></span><br><span class="line">LIB = -lssl -lcrypto</span><br><span class="line"><span class="comment">#引用头文件路径，带上-I， -I$(PREFIX_INC)</span></span><br><span class="line">INCLUDE = -I../<span class="keyword">include</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果为空，就是当前目录</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(SRCDIR)</span>,)</span><br><span class="line">	SRCDIR += ./</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下面四个命令通过模式匹配获取当前目录下的所有C,CPP,O文件</span></span><br><span class="line">CPP_SOURCES = <span class="variable">$(<span class="built_in">foreach</span> d,<span class="variable">$(SRCDIR)</span>,$(<span class="built_in">wildcard</span> <span class="variable">$(d)</span>*.cpp)</span>)</span><br><span class="line">C_SOURCES = <span class="variable">$(<span class="built_in">foreach</span> d,<span class="variable">$(SRCDIR)</span>,$(<span class="built_in">wildcard</span> <span class="variable">$(d)</span>*.c)</span>)</span><br><span class="line">CPP_OBJS = <span class="variable">$(<span class="built_in">patsubst</span> %.cpp, <span class="variable">$(OBJDIR)</span>%.o, <span class="variable">$(CPP_SOURCES)</span>)</span></span><br><span class="line">C_OBJS = <span class="variable">$(<span class="built_in">patsubst</span> %.c, <span class="variable">$(OBJDIR)</span>%.o, <span class="variable">$(C_SOURCES)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#下面把一些其他目录下的源文件也放到里面</span></span><br><span class="line">SOURCES += <span class="variable">$(CPP_SOURCES)</span> <span class="variable">$(C_SOURCES)</span> $(OBJS:%.o=%.c*)</span><br><span class="line">OBJS += <span class="variable">$(CPP_OBJS)</span> <span class="variable">$(C_OBJS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean all cp cpp cpso _clean _all _install test</span></span><br><span class="line"></span><br><span class="line"><span class="section">.SUFFIXES: .c .cpp .o</span></span><br><span class="line"></span><br><span class="line"><span class="section">.c.o:</span></span><br><span class="line">	<span class="variable">$(CC)</span> -c <span class="variable">$*</span>.c -o <span class="variable">$*</span>.o <span class="variable">$(INCLUDE)</span> <span class="variable">$(CFLAGS)</span></span><br><span class="line"><span class="section">.cpp.o:</span></span><br><span class="line">	<span class="variable">$(CXX)</span> -c <span class="variable">$*</span>.cpp -o <span class="variable">$*</span>.o <span class="variable">$(INCLUDE)</span> <span class="variable">$(CXXFLAGS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(OUTDIR)</span><span class="variable">$(TARGET)</span> <span class="variable">$(_all)</span></span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(OUTDIR)</span><span class="variable">$(TARGET)</span>: <span class="variable">$(OBJS)</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CPP_OBJS)</span>,)</span><br><span class="line">	<span class="variable">$(CC)</span>  <span class="variable">$(LFLAGS)</span> -o <span class="variable">$(OUTDIR)</span><span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span> <span class="variable">$(LIB_DIRS)</span> <span class="variable">$(LIB)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(LFLAGS)</span> -o <span class="variable">$(OUTDIR)</span><span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span> <span class="variable">$(LIB_DIRS)</span> <span class="variable">$(LIB)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean: <span class="variable">$(_clean)</span></span></span><br><span class="line">	rm -f <span class="variable">$(OUTDIR)</span><span class="variable">$(TARGET)</span> <span class="variable">$(OBJS)</span></span><br></pre></td></tr></table></figure><h4 id="cmake"><a href="#cmake" class="headerlink" title="cmake"></a>cmake</h4><ul><li>编写CMakeLists.txt，在windows上使用msvc编译的openssl主程序就需要使用msvc编译引擎</li><li>linux就使用gcc即可</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cmake最小支持版本3.8</span></span><br><span class="line"><span class="keyword">CMAKE_MINIMUM_REQUIRED</span>(VERSION <span class="number">3.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目工程名字</span></span><br><span class="line"><span class="keyword">PROJECT</span>(skf</span><br><span class="line">    LANGUAGES C CXX</span><br><span class="line">    VERSION <span class="number">1.0</span>.<span class="number">0.0</span></span><br><span class="line">    DESCRIPTION <span class="string">&quot;skf engine&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译命令导出json给其他地方使用</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_EXPORT_COMPILE_COMMANDS <span class="keyword">ON</span>)</span><br><span class="line"><span class="comment"># 设置C++标准</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span>(SRC_FILES)</span><br><span class="line"><span class="keyword">FILE</span>(GLOB SRC_FILES ./*.c*)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> SHARED <span class="variable">$&#123;SRC_FILES&#125;</span>)</span><br><span class="line"><span class="keyword">set_target_properties</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PROPERTIES PREFIX <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_include_directories</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">    ../<span class="keyword">include</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_directories</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">    ../</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (MSVC)</span><br><span class="line">    <span class="keyword">target_compile_options</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">        /wd4819 <span class="comment"># 对msvc关闭uincode的warning提示</span></span><br><span class="line">        /wd4996 <span class="comment"># 对msvc关闭unsafe func的提示</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">        libssl</span><br><span class="line">        libcrypto</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PRIVATE</span><br><span class="line">        ssl crypto</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure><h3 id="1-4-加载引擎"><a href="#1-4-加载引擎" class="headerlink" title="1.4. 加载引擎"></a>1.4. 加载引擎</h3><p><strong>libcurl调用</strong></p><ul><li>curl引擎设置如下</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">curlWriteFunction</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">size_t</span> size <span class="comment">/*always==1*/</span>, <span class="type">size_t</span> nmemb,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">void</span> *userdata)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span> **stringToWrite = (<span class="type">char</span> **)userdata;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *input = (<span class="type">const</span> <span class="type">char</span> *)ptr;</span><br><span class="line">    <span class="keyword">if</span> (nmemb == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!*stringToWrite)</span><br><span class="line">        *stringToWrite = (<span class="type">char</span> *)<span class="built_in">malloc</span>(nmemb + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        *stringToWrite = (<span class="type">char</span> *)<span class="built_in">realloc</span>(*stringToWrite, dataSize + nmemb + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(*stringToWrite + dataSize, input, nmemb);</span><br><span class="line">    dataSize += nmemb;</span><br><span class="line">    (*stringToWrite)[dataSize] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> nmemb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The SSL initialisation callback. The callback sets:</span></span><br><span class="line"><span class="comment">   - a private key and certificate</span></span><br><span class="line"><span class="comment">   - a trusted ca certificate</span></span><br><span class="line"><span class="comment">   - a preferred cipherlist</span></span><br><span class="line"><span class="comment">   - an application verification callback (the function above)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">static</span> CURLcode <span class="title">sslctxfun</span><span class="params">(CURL *curl, <span class="type">void</span> *sslctx, <span class="type">void</span> *parm)</span> </span>&#123;</span><br><span class="line">    SSL_CTX *ctx = (SSL_CTX *)sslctx;</span><br><span class="line">    ENGINE *ssl_client_engine = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ssl_client_engine = <span class="built_in">ENGINE_by_id</span>(<span class="string">&quot;skf&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ssl_client_engine == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;get engine failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">SSL_CTX_set_client_cert_engine</span>(ctx, ssl_client_engine)) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Error setting client auth engine\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CURLE_OK;</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">ENGINE_free</span>(ssl_client_engine);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> CURLE_FAILED_INIT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stdout, <span class="string">&quot;Usage: curl_engine.exe &lt;URL&gt;\n&quot;</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(stdout, <span class="string">&quot;\texample: curl_engine.exe https://xxx.xxx.xxx.xxx\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *data = <span class="number">0</span>;</span><br><span class="line">    CURL *<span class="type">const</span> curl = <span class="built_in">curl_easy_init</span>();</span><br><span class="line">    <span class="keyword">if</span> (!curl) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Failed to init curl&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_URL, argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_VERBOSE, <span class="number">1L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/******************** 引擎加载选项 begin ********************/</span></span><br><span class="line">    <span class="comment">// 设置curl加载引擎</span></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_SSLENGINE, <span class="string">&quot;skf&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置curl将默认算法使用引擎提供的算法</span></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_SSLENGINE_DEFAULT, <span class="number">1L</span>);</span><br><span class="line">    <span class="comment">// 如果需要使用引擎中的客户端提供证书接口，需要设置此选项</span></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_SSL_CTX_FUNCTION, sslctxfun);</span><br><span class="line">    <span class="comment">/******************** 引擎加载选项 end ********************/</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_CONNECTTIMEOUT_MS, <span class="number">3</span> * <span class="number">1000</span>);</span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_TIMEOUT_MS, <span class="number">3</span> * <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_SSL_VERIFYPEER, <span class="number">0L</span>);</span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_SSL_VERIFYHOST, <span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_WRITEDATA, &amp;data);</span><br><span class="line">    <span class="built_in">curl_easy_setopt</span>(curl, CURLOPT_WRITEFUNCTION, &amp;curlWriteFunction);</span><br><span class="line"></span><br><span class="line">    CURLcode mc = <span class="built_in">curl_easy_perform</span>(curl);</span><br><span class="line">    <span class="keyword">if</span> (mc != CURLE_OK) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Failed to get web page, curl error: %s\n&quot;</span>,</span><br><span class="line">                <span class="built_in">curl_easy_strerror</span>(mc));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">curl_easy_cleanup</span>(curl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!data) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Got no data\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Page data:\n\n%s\n&quot;</span>, data);</span><br><span class="line">    <span class="built_in">free</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-5-测试命令"><a href="#1-5-测试命令" class="headerlink" title="1.5. 测试命令"></a>1.5. 测试命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端监听命令，重点是-CAfile需要使用ukey里面的证书对应的ca根证书</span></span><br><span class="line">openssl s_server -accept 777 -tls1_1 -state -debug -cipher ECC-SM4-SM3 -state -key ./apps/certs/sm2sign.key -cert ./apps/certs/sm2sign.crt -ekey ./apps/certs/sm2enc.key -ecert ./apps/certs/sm2enc.crt -CAfile ./apps/certs/server.crt -Verify 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端请求使用skf引擎</span></span><br><span class="line">openssl s_client -engine skf -ssl_client_engine skf -connect 127.0.0.1:777 -state -cipher ECC-SM4-SM3</span><br></pre></td></tr></table></figure><h3 id="1-6-使用skf接口实现rsa引擎"><a href="#1-6-使用skf接口实现rsa引擎" class="headerlink" title="1.6. 使用skf接口实现rsa引擎"></a>1.6. 使用skf接口实现rsa引擎</h3><ul><li>openssl的rsa签名校验原理先看 <a href="#4-rsa%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%A0%A1%E9%AA%8C">rsa签名与校验</a>，后文对于相关的知识讲解会略过</li><li><a target="_blank" rel="noopener" href="https://max.book118.com/html/2018/0618/173250950.shtm">skf接口文档</a></li></ul><h4 id="1-需要用到的skf引擎的关键函数"><a href="#1-需要用到的skf引擎的关键函数" class="headerlink" title="1) 需要用到的skf引擎的关键函数"></a>1) 需要用到的skf引擎的关键函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出证书</span></span><br><span class="line"><span class="comment">// bSignFlag TRUE为签名证书，FALSE为加密证书</span></span><br><span class="line"><span class="function">ULONG DEVAPI <span class="title">SKF_ExportCertificate</span><span class="params">(HCONTAINER hContainer, BOOL bSignFlag,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   BYTE *pbCert, ULONG *pulCertLen)</span></span>;</span><br><span class="line"><span class="comment">// 导出证书的公钥</span></span><br><span class="line"><span class="comment">// bSignFlag TRUE为签名证书，FALSE为加密证书</span></span><br><span class="line"><span class="function">ULONG DEVAPI <span class="title">SKF_ExportPublicKey</span><span class="params">(HCONTAINER hContainer, BOOL bSignFlag,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 BYTE *pbBlob, ULONG *pulBlobLen)</span></span>;</span><br><span class="line"><span class="comment">// 使用签名证书的私钥进行签名</span></span><br><span class="line"><span class="function">ULONG DEVAPI <span class="title">SKF_RSASignData</span><span class="params">(HCONTAINER hContainer, BYTE *pbData,</span></span></span><br><span class="line"><span class="params"><span class="function">                             ULONG ulDataLen, BYTE *pbSignature,</span></span></span><br><span class="line"><span class="params"><span class="function">                             ULONG *pulSignLen)</span></span>;</span><br><span class="line"><span class="comment">// 获取容器类型，1为rsa，2为ecc</span></span><br><span class="line"><span class="function">ULONG DEVAPI <span class="title">SKF_GetContainerType</span><span class="params">(HCONTAINER hContainer,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  ULONG *pulContainerType)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="2-skf导出数据到openssl结构体的工具函数"><a href="#2-skf导出数据到openssl结构体的工具函数" class="headerlink" title="2) skf导出数据到openssl结构体的工具函数"></a>2) skf导出数据到openssl结构体的工具函数</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将导出的公钥结构体设置到rsa结构体的公钥部分</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RSA_set_RSAPUBLICKEYBLOB</span><span class="params">(RSA *rsa, <span class="type">const</span> RSAPUBLICKEYBLOB *blob)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	BIGNUM *n = <span class="literal">NULL</span>;</span><br><span class="line">	BIGNUM *e = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!rsa || !blob) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;!rsa || !blob&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((blob-&gt;BitLen &lt; OPENSSL_RSA_FIPS_MIN_MODULUS_BITS)</span><br><span class="line">		|| (blob-&gt;BitLen &gt; <span class="built_in">sizeof</span>(blob-&gt;Modulus) * <span class="number">8</span>)</span><br><span class="line">		|| (blob-&gt;BitLen % <span class="number">8</span> != <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;blob-&gt;BitLen &lt; OPENSSL_RSA_FIPS_MIN_MODULUS_BITS&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导出两个大质数的乘积n</span></span><br><span class="line">	<span class="keyword">if</span> (!(n = <span class="built_in">BN_bin2bn</span>(blob-&gt;Modulus, <span class="built_in">sizeof</span>(blob-&gt;Modulus), <span class="literal">NULL</span>))) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;n = BN_bin2bn(blob-&gt;Modulus, sizeof(blob-&gt;Modulus), NULL)&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导出公钥的e</span></span><br><span class="line">	<span class="keyword">if</span> (!(e = <span class="built_in">BN_bin2bn</span>(blob-&gt;PublicExponent,</span><br><span class="line">		<span class="built_in">sizeof</span>(blob-&gt;PublicExponent), <span class="literal">NULL</span>))) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;e = BN_bin2bn(blob-&gt;PublicExponent&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置rsa的n和e，对应的是rsa算法的公钥部分</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">RSA_set0_key</span>(rsa, n, e, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;RSA_set0_key(rsa, n, e, NULL)&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line">	n = <span class="literal">NULL</span>;</span><br><span class="line">	e = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">	<span class="built_in">BN_free</span>(n);</span><br><span class="line">	<span class="built_in">BN_free</span>(e);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-openssl中需要用到的一些函数和结构体讲解"><a href="#3-openssl中需要用到的一些函数和结构体讲解" class="headerlink" title="3) openssl中需要用到的一些函数和结构体讲解"></a>3) openssl中需要用到的一些函数和结构体讲解</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********** include/openssl/rsa.h **********/</span></span><br><span class="line"><span class="comment">// 获取openssl内置的默认rsa_method</span></span><br><span class="line"><span class="function"><span class="type">const</span> RSA_METHOD *<span class="title">RSA_get_default_method</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// 将已有的rsa_method拷贝一份，防止修改到原始的结构体</span></span><br><span class="line"><span class="function">RSA_METHOD *<span class="title">RSA_meth_dup</span><span class="params">(<span class="type">const</span> RSA_METHOD *meth)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/********** include/openssl/engine.h **********/</span></span><br><span class="line"><span class="comment">// 在引擎中设置rsa_meth，skf接口需要自定义一些算法，所以要自定义rsa_meth</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ENGINE_set_RSA</span><span class="params">(ENGINE *e, <span class="type">const</span> RSA_METHOD *rsa_meth)</span></span>;</span><br><span class="line"><span class="comment">// 设置加载客户端证书的函数，这里要自定义从skf接口取出证书</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ENGINE_set_load_ssl_client_cert_function</span><span class="params">(ENGINE *e,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             ENGINE_SSL_CLIENT_CERT_PTR</span></span></span><br><span class="line"><span class="params"><span class="function">                                             loadssl_f)</span></span>;</span><br></pre></td></tr></table></figure><ul><li><code>rsa_method</code>是非导出的，具体的内容如下</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// crypto/rsa/rsa_local.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rsa_meth_st</span> &#123;</span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    <span class="comment">// 公钥加密函数</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_pub_enc) (<span class="type">int</span> flen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *from,</span><br><span class="line">                        <span class="type">unsigned</span> <span class="type">char</span> *to, RSA *rsa, <span class="type">int</span> padding);</span><br><span class="line">    <span class="comment">// 公钥解密函数</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_pub_dec) (<span class="type">int</span> flen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *from,</span><br><span class="line">                        <span class="type">unsigned</span> <span class="type">char</span> *to, RSA *rsa, <span class="type">int</span> padding);</span><br><span class="line">    <span class="comment">// 私钥加密函数</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_priv_enc) (<span class="type">int</span> flen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *from,</span><br><span class="line">                         <span class="type">unsigned</span> <span class="type">char</span> *to, RSA *rsa, <span class="type">int</span> padding);</span><br><span class="line">    <span class="comment">// 私钥解密函数</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_priv_dec) (<span class="type">int</span> flen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *from,</span><br><span class="line">                         <span class="type">unsigned</span> <span class="type">char</span> *to, RSA *rsa, <span class="type">int</span> padding);</span><br><span class="line">    <span class="comment">// 默认私钥解密函数中用到的模解密函数，rsa-&gt;flags控制使用哪一个</span></span><br><span class="line">    <span class="comment">/* Can be null */</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_mod_exp) (BIGNUM *r0, <span class="type">const</span> BIGNUM *I, RSA *rsa, BN_CTX *ctx);</span><br><span class="line">    <span class="comment">// 和上面一样默认私钥解密函数中用到的模解密函数，用到的是n和d</span></span><br><span class="line">    <span class="comment">/* Can be null */</span></span><br><span class="line">    <span class="built_in">int</span> (*bn_mod_exp) (BIGNUM *r, <span class="type">const</span> BIGNUM *a, <span class="type">const</span> BIGNUM *p,</span><br><span class="line">                       <span class="type">const</span> BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx);</span><br><span class="line">    <span class="comment">/* called at new */</span></span><br><span class="line">    <span class="built_in">int</span> (*init) (RSA *rsa);</span><br><span class="line">    <span class="comment">/* called at free */</span></span><br><span class="line">    <span class="built_in">int</span> (*finish) (RSA *rsa);</span><br><span class="line">    <span class="comment">/* RSA_METHOD_FLAG_* things */</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    <span class="comment">/* may be needed! */</span></span><br><span class="line">    <span class="type">char</span> *app_data;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * New sign and verify functions: some libraries don&#x27;t allow arbitrary</span></span><br><span class="line"><span class="comment">     * data to be signed/verified: this allows them to be used. Note: for</span></span><br><span class="line"><span class="comment">     * this to work the RSA_public_decrypt() and RSA_private_encrypt() should</span></span><br><span class="line"><span class="comment">     * *NOT* be used RSA_sign(), RSA_verify() should be used instead.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_sign) (<span class="type">int</span> type,</span><br><span class="line">                     <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m, <span class="type">unsigned</span> <span class="type">int</span> m_length,</span><br><span class="line">                     <span class="type">unsigned</span> <span class="type">char</span> *sigret, <span class="type">unsigned</span> <span class="type">int</span> *siglen,</span><br><span class="line">                     <span class="type">const</span> RSA *rsa);</span><br><span class="line">    <span class="built_in">int</span> (*rsa_verify) (<span class="type">int</span> dtype, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m,</span><br><span class="line">                       <span class="type">unsigned</span> <span class="type">int</span> m_length, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *sigbuf,</span><br><span class="line">                       <span class="type">unsigned</span> <span class="type">int</span> siglen, <span class="type">const</span> RSA *rsa);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If this callback is NULL, the builtin software RSA key-gen will be</span></span><br><span class="line"><span class="comment">     * used. This is for behavioural compatibility whilst the code gets</span></span><br><span class="line"><span class="comment">     * rewired, but one day it would be nice to assume there are no such</span></span><br><span class="line"><span class="comment">     * things as &quot;builtin software&quot; implementations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">int</span> (*rsa_keygen) (RSA *rsa, <span class="type">int</span> bits, BIGNUM *e, BN_GENCB *cb);</span><br><span class="line">    <span class="built_in">int</span> (*rsa_multi_prime_keygen) (RSA *rsa, <span class="type">int</span> bits, <span class="type">int</span> primes,</span><br><span class="line">                                   BIGNUM *e, BN_GENCB *cb);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>openssl的默认<code>rsa_method</code>如下</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// crypto/rsa/rsa_ossl.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> RSA_METHOD rsa_pkcs1_ossl_meth = &#123;</span><br><span class="line">    <span class="string">&quot;OpenSSL PKCS#1 RSA&quot;</span>,</span><br><span class="line">    rsa_ossl_public_encrypt,</span><br><span class="line">    rsa_ossl_public_decrypt,     <span class="comment">/* signature verification */</span></span><br><span class="line">    rsa_ossl_private_encrypt,    <span class="comment">/* signing */</span></span><br><span class="line">    rsa_ossl_private_decrypt,</span><br><span class="line">    rsa_ossl_mod_exp,</span><br><span class="line">    BN_mod_exp_mont,            <span class="comment">/* XXX probably we should not use Montgomery</span></span><br><span class="line"><span class="comment">                                 * if e == 3 */</span></span><br><span class="line">    rsa_ossl_init,</span><br><span class="line">    rsa_ossl_finish,</span><br><span class="line">    RSA_FLAG_FIPS_METHOD,       <span class="comment">/* flags */</span></span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="comment">// sign和verify标0代表使用默认签名和校验函数，而非不使用</span></span><br><span class="line">    <span class="number">0</span>,                          <span class="comment">/* rsa_sign */</span></span><br><span class="line">    <span class="number">0</span>,                          <span class="comment">/* rsa_verify */</span></span><br><span class="line">    <span class="literal">NULL</span>,                       <span class="comment">/* rsa_keygen */</span></span><br><span class="line">    <span class="literal">NULL</span>                        <span class="comment">/* rsa_multi_prime_keygen */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> RSA_METHOD *default_RSA_meth = &amp;rsa_pkcs1_ossl_meth;</span><br></pre></td></tr></table></figure><h4 id="4-结合skf和openssl的原理讲解一下"><a href="#4-结合skf和openssl的原理讲解一下" class="headerlink" title="4) 结合skf和openssl的原理讲解一下"></a>4) 结合skf和openssl的原理讲解一下</h4><ul><li>使用skf引擎一般是使用ukey进行证书双向认证，双向认证的流程解析查看 <a href="#2-%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">双向认证流程</a></li><li>ukey保证安全性，私钥是不允许导出的，所以<strong>私钥签名</strong>这一步需要自己实现</li><li>证书存在于ukey中，所以需要修改<strong>加载证书</strong>的函数</li><li>私钥解密不需要，因为双向认证过程中没有服务端使用客户端上传的公钥加密的过程</li><li>公钥加密在客户端角度是使用服务端的公钥加密上传的数据，这里软件实现即可，不需要ukey的硬件实现</li><li>公钥解密同样软件实现即可</li></ul><h4 id="5-引擎设置代码"><a href="#5-引擎设置代码" class="headerlink" title="5) 引擎设置代码"></a>5) 引擎设置代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">skf_load_rsa_client_cert</span><span class="params">(X509** pcert, EVP_PKEY** ppkey)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* operation = <span class="string">&quot;load rsa client cert&quot;</span>;</span><br><span class="line">    RSAPUBLICKEYBLOB pubKey = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    EVP_PKEY* pkey = <span class="literal">NULL</span>;</span><br><span class="line">    RSA* r = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> iResult = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> certContetBITS[<span class="number">8192</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ULONG ulCertLen = <span class="built_in">sizeof</span>(certContetBITS);</span><br><span class="line">    BIO* b = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LOG_INFO</span>(Tag, <span class="string">&quot;%s&quot;</span>, operation);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((pkey = <span class="built_in">EVP_PKEY_new</span>()) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s] new EVP_PKEY failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 导出公钥写入算法结构体</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">exportPublicKey</span>(TRUE, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>*&gt;(&amp;pubKey), <span class="built_in">sizeof</span>(pubKey)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s] export public key from skf failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(Tag, <span class="string">&quot;export public key success&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((r = <span class="built_in">RSA_new</span>()) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s] new RSA failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">RSA_set_RSAPUBLICKEYBLOB</span>(r, &amp;pubKey)) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s] set public key to rsa failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">EVP_PKEY_assign_RSA</span>(pkey, r)) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s] assign rsa to EVP_KEY failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        *ppkey = pkey;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 导出签名证书写入证书指针</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">exportCertificate</span>(TRUE, certContetBITS, ulCertLen)) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s], export sign certificate by skf failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(Tag, <span class="string">&quot;export sign certificate by skf certLen[%d]&quot;</span>, ulCertLen);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((b = <span class="built_in">BIO_new</span>(<span class="built_in">BIO_s_mem</span>())) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s], new BIO failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">BIO_write</span>(b, certContetBITS, ulCertLen);</span><br><span class="line">        *pcert = <span class="built_in">d2i_X509_bio</span>(b, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (*pcert == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">LOG_ERROR</span>(Tag, <span class="string">&quot;[%s], d2i_X509_bio failed&quot;</span>, operation);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        iResult = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">LOG_INFO</span>(Tag, <span class="string">&quot;%s success&quot;</span>, operation);</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (b != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">BIO_free</span>(b);</span><br><span class="line">        b = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 成功部分指针不需要清理</span></span><br><span class="line">    <span class="keyword">if</span> (iResult == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> iResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">RSA_free</span>(r);</span><br><span class="line">        r = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pkey != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">EVP_PKEY_free</span>(pkey);</span><br><span class="line">        pkey = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> iResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">skf_load_ssl_client_cert</span><span class="params">(ENGINE* e, SSL* ssl, STACK_OF(X509_NAME) * ca_dn, X509** pcert,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    EVP_PKEY** ppkey, STACK_OF(X509) * *pother,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    UI_METHOD* ui_method, <span class="type">void</span>* callback_data)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* operation = <span class="string">&quot;skf_load_ssl_client_cert&quot;</span>;</span><br><span class="line">    <span class="built_in">LOG_DEBUG</span>(Tag, <span class="string">&quot;%s&quot;</span>, operation);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">getContainerType</span>() == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">skf_load_rsa_client_cert</span>(pcert, ppkey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// only handle rsa, other return false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">skf_rsa_priv_enc</span><span class="params">(<span class="type">int</span> flen, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* from, <span class="type">unsigned</span> <span class="type">char</span>* to, RSA* rsa,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">int</span> padding)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_DEBUG</span>(Tag, <span class="string">&quot;skf_rsa_priv_enc from len %d, padding %d&quot;</span>, flen, padding);</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">rsaDoSign</span>(from, flen, to, <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">LOG_DEBUG</span>(Tag, <span class="string">&quot;rsaDoSign ret %d&quot;</span>, ret);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> RSA_METHOD* skf_rsa_method = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">/* Prepare the ENGINE structure for registration */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">skf_bind_helper</span><span class="params">(ENGINE* e)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_DEBUG</span>(Tag, <span class="string">&quot;skf_bind_helper&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set skf rsa engine method, use default method and diy some function</span></span><br><span class="line">    <span class="keyword">if</span> ((skf_rsa_method = <span class="built_in">RSA_meth_dup</span>(<span class="built_in">RSA_get_default_method</span>())) == <span class="literal">NULL</span> ||</span><br><span class="line">        <span class="comment">// do not need priv_dec</span></span><br><span class="line">        <span class="built_in">RSA_meth_set_priv_dec</span>(skf_rsa_method, <span class="literal">NULL</span>) == <span class="number">0</span> ||</span><br><span class="line">        <span class="comment">// skf provide priv_enc</span></span><br><span class="line">        <span class="built_in">RSA_meth_set_priv_enc</span>(skf_rsa_method, skf_rsa_priv_enc) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ENGINE_set_id</span>(e, engine_epass_id) || !<span class="built_in">ENGINE_set_name</span>(e, engine_epass_name) ||</span><br><span class="line">        !<span class="built_in">ENGINE_set_init_function</span>(e, epass_init) ||</span><br><span class="line">        <span class="comment">// set rsa method</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_RSA</span>(e, skf_rsa_method) ||</span><br><span class="line">        <span class="comment">// if not set, sdf will load by default if possible</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_flags</span>(e, ENGINE_FLAGS_NO_REGISTER_ALL) ||</span><br><span class="line">        !<span class="built_in">ENGINE_set_destroy_function</span>(e, epass_destroy) ||</span><br><span class="line">        !<span class="built_in">ENGINE_set_finish_function</span>(e, epass_finish) || !<span class="built_in">ENGINE_set_ctrl_function</span>(e, epass_ctrl) ||</span><br><span class="line">        !<span class="built_in">ENGINE_set_cmd_defns</span>(e, epass_cmd_defns) ||</span><br><span class="line">        !<span class="built_in">ENGINE_set_load_privkey_function</span>(e, epass_load_key) ||</span><br><span class="line">        <span class="comment">// set load client cert</span></span><br><span class="line">        !<span class="built_in">ENGINE_set_load_ssl_client_cert_function</span>(e, skf_load_ssl_client_cert)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-7-使用skf接口实现sm2国密引擎"><a href="#1-7-使用skf接口实现sm2国密引擎" class="headerlink" title="1.7. 使用skf接口实现sm2国密引擎"></a>1.7. 使用skf接口实现sm2国密引擎</h3><h2 id="2-随机数生成算法"><a href="#2-随机数生成算法" class="headerlink" title="2. 随机数生成算法"></a>2. 随机数生成算法</h2><ul><li>需要链接<code>-lcrypto</code></li><li>内部会获取<code>/dev/urandom</code>、<code>pid</code>、<code>tid</code>、<code>时间</code>作为种子，所以相同种子也会有不同随机数</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/rand.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">255</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 设置种子，也可以不设置，加上会增加随机性</span></span><br><span class="line">    <span class="built_in">RAND_seed</span>(buf, <span class="keyword">sizeof</span> buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buf1[<span class="number">255</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">RAND_bytes</span>(buf, <span class="keyword">sizeof</span> buf1);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-错误信息输出"><a href="#3-错误信息输出" class="headerlink" title="3. 错误信息输出"></a>3. 错误信息输出</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ret = <span class="built_in">RSA_verify</span>(NID_sha1, testmd, <span class="number">20</span>, sig, len, rsa);</span><br><span class="line"><span class="keyword">if</span> (ret != <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> e = <span class="built_in">ERR_get_error</span>();</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">255</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;NID_sha1 verify ret &#123;&#125;, reason &#123;&#125;&quot;</span>, ret, <span class="built_in">ERR_error_string</span>(e, buf));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-rsa签名与校验"><a href="#4-rsa签名与校验" class="headerlink" title="4. rsa签名与校验"></a>4. rsa签名与校验</h2><p>RSA原理先看 <a href="/blogs/2022-03-23-cryptography/#2-RSA%E7%AE%97%E6%B3%95">RSA算法</a></p><h3 id="4-1-接口和结构体"><a href="#4-1-接口和结构体" class="headerlink" title="4.1. 接口和结构体"></a>4.1. 接口和结构体</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// openssl/rsa.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following 2 functions sign and verify a X509_SIG ASN1 object inside</span></span><br><span class="line"><span class="comment"> * PKCS#1 padded RSA encryption</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RSA_sign</span><span class="params">(<span class="type">int</span> type, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m, <span class="type">unsigned</span> <span class="type">int</span> m_length,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">unsigned</span> <span class="type">char</span> *sigret, <span class="type">unsigned</span> <span class="type">int</span> *siglen, RSA *rsa)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RSA_verify</span><span class="params">(<span class="type">int</span> type, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m, <span class="type">unsigned</span> <span class="type">int</span> m_length,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *sigbuf, <span class="type">unsigned</span> <span class="type">int</span> siglen, RSA *rsa)</span></span>;</span><br></pre></td></tr></table></figure><ul><li>其中<code>m</code>和<code>m_length</code>是原文数据</li><li><code>sigret</code>和<code>siglen</code>是加密后的数据</li><li><code>type</code>定义了摘要算法类型，这里是重点，传入的m并不会直接进行加密，而是先经过摘要计算一次，在进行加密</li><li><code>rsa</code>是算法结构体，在计算过程中可以使用到，在不同的函数需要的结构体不一样，下面讲一下算法结构体</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/openssl/ossl_typ.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">rsa_st</span> RSA;</span><br><span class="line"></span><br><span class="line"><span class="comment">// crypto/rsa/rsa_local.h</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rsa_st</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * The first parameter is used to pickup errors where this is passed</span></span><br><span class="line"><span class="comment">     * instead of an EVP_PKEY, it is set to 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> pad;</span><br><span class="line">    <span class="type">int32_t</span> version;</span><br><span class="line">    <span class="type">const</span> RSA_METHOD *meth;</span><br><span class="line">    <span class="comment">/* functional reference if &#x27;meth&#x27; is ENGINE-provided */</span></span><br><span class="line">    ENGINE *engine; <span class="comment">// 引擎，自定义算法时定义</span></span><br><span class="line">    BIGNUM *n;      <span class="comment">// 公钥和私钥都需要的数据，n=p*q</span></span><br><span class="line">    BIGNUM *e;      <span class="comment">// 公钥数据，验签需要</span></span><br><span class="line">    BIGNUM *d;      <span class="comment">// 私钥数据，加密需要</span></span><br><span class="line">    BIGNUM *p;      <span class="comment">// 选取的大质数，内部数据，加解密不需要这个</span></span><br><span class="line">    BIGNUM *q;      <span class="comment">// 选取的大质数，内部数据，加解密不需要这个</span></span><br><span class="line">    BIGNUM *dmp1;</span><br><span class="line">    BIGNUM *dmq1;</span><br><span class="line">    BIGNUM *iqmp;</span><br><span class="line">    <span class="comment">/* for multi-prime RSA, defined in RFC 8017 */</span></span><br><span class="line">    <span class="built_in">STACK_OF</span>(RSA_PRIME_INFO) *prime_infos;</span><br><span class="line">    <span class="comment">/* If a PSS only key this contains the parameter restrictions */</span></span><br><span class="line">    RSA_PSS_PARAMS *pss;</span><br><span class="line">    <span class="comment">/* be careful using this if the RSA structure is shared */</span></span><br><span class="line">    CRYPTO_EX_DATA ex_data;</span><br><span class="line">    CRYPTO_REF_COUNT references;</span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line">    <span class="comment">/* Used to cache montgomery values */</span></span><br><span class="line">    BN_MONT_CTX *_method_mod_n;</span><br><span class="line">    BN_MONT_CTX *_method_mod_p;</span><br><span class="line">    BN_MONT_CTX *_method_mod_q;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * all BIGNUM values are actually in the following data, if it is not</span></span><br><span class="line"><span class="comment">     * NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">char</span> *bignum_data;</span><br><span class="line">    BN_BLINDING *blinding;</span><br><span class="line">    BN_BLINDING *mt_blinding;</span><br><span class="line">    CRYPTO_RWLOCK *lock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-2-RSA-sign源码解析"><a href="#4-2-RSA-sign源码解析" class="headerlink" title="4.2. RSA_sign源码解析"></a>4.2. <code>RSA_sign</code>源码解析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// crypto/rsa/rsa_sign.c</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RSA_sign</span><span class="params">(<span class="type">int</span> type, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m, <span class="type">unsigned</span> <span class="type">int</span> m_len,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">unsigned</span> <span class="type">char</span> *sigret, <span class="type">unsigned</span> <span class="type">int</span> *siglen, RSA *rsa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> encrypt_len, encoded_len = <span class="number">0</span>, ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *tmps = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *encoded = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里判断是否存在自定义sign函数，一般由引擎指定</span></span><br><span class="line">    <span class="keyword">if</span> (rsa-&gt;meth-&gt;rsa_sign) &#123;</span><br><span class="line">        <span class="keyword">return</span> rsa-&gt;meth-&gt;<span class="built_in">rsa_sign</span>(type, m, m_len, sigret, siglen, rsa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 先进行编码，根据type做不同的编码，也就是摘要算法</span></span><br><span class="line">    <span class="comment">/* Compute the encoded digest. */</span></span><br><span class="line">    <span class="keyword">if</span> (type == NID_md5_sha1) &#123;</span><br><span class="line">        <span class="comment">// 这里看起来像是md5_sha1算法需要外部自己算好，传进来的只能是36位</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * NID_md5_sha1 corresponds to the MD5/SHA1 combination in TLS 1.1 and</span></span><br><span class="line"><span class="comment">         * earlier. It has no DigestInfo wrapper but otherwise is</span></span><br><span class="line"><span class="comment">         * RSASSA-PKCS1-v1_5.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (m_len != SSL_SIG_LENGTH) &#123;</span><br><span class="line">            <span class="built_in">RSAerr</span>(RSA_F_RSA_SIGN, RSA_R_INVALID_MESSAGE_LENGTH);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        encoded_len = SSL_SIG_LENGTH;</span><br><span class="line">        encoded = m;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 这一步会根据不用的type进行不同的编码，具体type定义在 openssl/obj_mac.h</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">encode_pkcs1</span>(&amp;tmps, &amp;encoded_len, type, m, m_len))</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        encoded = tmps;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断了编码后的数据必须小于rsa支持的加密长度减去RSA_PKCS1_PADDING会占用的最小长度</span></span><br><span class="line">    <span class="keyword">if</span> (encoded_len &gt; <span class="built_in">RSA_size</span>(rsa) - RSA_PKCS1_PADDING_SIZE) &#123;</span><br><span class="line">        <span class="built_in">RSAerr</span>(RSA_F_RSA_SIGN, RSA_R_DIGEST_TOO_BIG_FOR_RSA_KEY);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 真正进行加密，使用的是编码后的数据进行加密</span></span><br><span class="line">    <span class="comment">// 默认使用RSA_PKCS1_PADDING算法进行添加padding，会自动添加padding</span></span><br><span class="line">    <span class="comment">// 注意加密使用的是私钥，所以rsa里面只需要存放私钥就可以了</span></span><br><span class="line">    encrypt_len = <span class="built_in">RSA_private_encrypt</span>(encoded_len, encoded, sigret, rsa,</span><br><span class="line">                                      RSA_PKCS1_PADDING);</span><br><span class="line">    <span class="keyword">if</span> (encrypt_len &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">    *siglen = encrypt_len;</span><br><span class="line">    ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">    <span class="built_in">OPENSSL_clear_free</span>(tmps, (<span class="type">size_t</span>)encoded_len);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-RSA-verify源码解析"><a href="#4-3-RSA-verify源码解析" class="headerlink" title="4.3. RSA_verify源码解析"></a>4.3. <code>RSA_verify</code>源码解析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// crypto/rsa/rsa_sign.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * int_rsa_verify verifies an RSA signature in |sigbuf| using |rsa|. It may be</span></span><br><span class="line"><span class="comment"> * called in two modes. If |rm| is NULL, it verifies the signature for digest</span></span><br><span class="line"><span class="comment"> * |m|. Otherwise, it recovers the digest from the signature, writing the digest</span></span><br><span class="line"><span class="comment"> * to |rm| and the length to |*prm_len|. |type| is the NID of the digest</span></span><br><span class="line"><span class="comment"> * algorithm to use. It returns one on successful verification and zero</span></span><br><span class="line"><span class="comment"> * otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">int_rsa_verify</span><span class="params">(<span class="type">int</span> type, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m, <span class="type">unsigned</span> <span class="type">int</span> m_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">unsigned</span> <span class="type">char</span> *rm, <span class="type">size_t</span> *prm_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *sigbuf, <span class="type">size_t</span> siglen, RSA *rsa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> decrypt_len, ret = <span class="number">0</span>, encoded_len = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *decrypt_buf = <span class="literal">NULL</span>, *encoded = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断siglen是否符合RSA中定义的可解密的长度</span></span><br><span class="line">    <span class="keyword">if</span> (siglen != (<span class="type">size_t</span>)<span class="built_in">RSA_size</span>(rsa)) &#123;</span><br><span class="line">        <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_WRONG_SIGNATURE_LENGTH);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Recover the encoded digest. */</span></span><br><span class="line">    decrypt_buf = <span class="built_in">OPENSSL_malloc</span>(siglen);</span><br><span class="line">    <span class="keyword">if</span> (decrypt_buf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, ERR_R_MALLOC_FAILURE);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 第一步就是直接使用公钥进行解密，同样默认使用RSA_PKCS1_PADDING</span></span><br><span class="line">    <span class="comment">// verify需要的是公钥，所以rsa中只需要存放公钥就可以了</span></span><br><span class="line">    <span class="comment">// 返回的数据已经去除了padding</span></span><br><span class="line">    decrypt_len = <span class="built_in">RSA_public_decrypt</span>((<span class="type">int</span>)siglen, sigbuf, decrypt_buf, rsa,</span><br><span class="line">                                     RSA_PKCS1_PADDING);</span><br><span class="line">    <span class="keyword">if</span> (decrypt_len &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type == NID_md5_sha1) &#123;</span><br><span class="line">        <span class="comment">// md5_sha1直接判断解密后的数据是否和传入的一致</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * NID_md5_sha1 corresponds to the MD5/SHA1 combination in TLS 1.1 and</span></span><br><span class="line"><span class="comment">         * earlier. It has no DigestInfo wrapper but otherwise is</span></span><br><span class="line"><span class="comment">         * RSASSA-PKCS1-v1_5.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (decrypt_len != SSL_SIG_LENGTH) &#123;</span><br><span class="line">            <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_BAD_SIGNATURE);</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rm != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(rm, decrypt_buf, SSL_SIG_LENGTH);</span><br><span class="line">            *prm_len = SSL_SIG_LENGTH;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_len != SSL_SIG_LENGTH) &#123;</span><br><span class="line">                <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_INVALID_MESSAGE_LENGTH);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">memcmp</span>(decrypt_buf, m, SSL_SIG_LENGTH) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_BAD_SIGNATURE);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == NID_mdc2 &amp;&amp; decrypt_len == <span class="number">2</span> + <span class="number">16</span></span><br><span class="line">               &amp;&amp; decrypt_buf[<span class="number">0</span>] == <span class="number">0x04</span> &amp;&amp; decrypt_buf[<span class="number">1</span>] == <span class="number">0x10</span>) &#123;</span><br><span class="line">        <span class="comment">// mdc2算法需要解密后的数据前两字节固定，解密后长度必须是18，然后判断原文和解密后的第3字节开始的16字节是否对应</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Oddball MDC2 case: signature can be OCTET STRING. check for correct</span></span><br><span class="line"><span class="comment">         * tag and length octets.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (rm != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(rm, decrypt_buf + <span class="number">2</span>, <span class="number">16</span>);</span><br><span class="line">            *prm_len = <span class="number">16</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_len != <span class="number">16</span>) &#123;</span><br><span class="line">                <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_INVALID_MESSAGE_LENGTH);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">memcmp</span>(m, decrypt_buf + <span class="number">2</span>, <span class="number">16</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_BAD_SIGNATURE);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If recovering the digest, extract a digest-sized output from the end</span></span><br><span class="line"><span class="comment">         * of |decrypt_buf| for |encode_pkcs1|, then compare the decryption</span></span><br><span class="line"><span class="comment">         * output as in a standard verification.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (rm != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="type">const</span> EVP_MD *md = <span class="built_in">EVP_get_digestbynid</span>(type);</span><br><span class="line">            <span class="keyword">if</span> (md == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_UNKNOWN_ALGORITHM_TYPE);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            m_len = <span class="built_in">EVP_MD_size</span>(md);</span><br><span class="line">            <span class="keyword">if</span> (m_len &gt; (<span class="type">size_t</span>)decrypt_len) &#123;</span><br><span class="line">                <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_INVALID_DIGEST_LENGTH);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">            m = decrypt_buf + decrypt_len - m_len;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Construct the encoded digest and ensure it matches. */</span></span><br><span class="line">        <span class="comment">// 这里就先对原文进行了编码，和RSA_sign逻辑一样</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">encode_pkcs1</span>(&amp;encoded, &amp;encoded_len, type, m, m_len))</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 然后判断编码后的和解密出来的是否一致</span></span><br><span class="line">        <span class="keyword">if</span> (encoded_len != decrypt_len</span><br><span class="line">            || <span class="built_in">memcmp</span>(encoded, decrypt_buf, encoded_len) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">RSAerr</span>(RSA_F_INT_RSA_VERIFY, RSA_R_BAD_SIGNATURE);</span><br><span class="line">            <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Output the recovered digest. */</span></span><br><span class="line">        <span class="keyword">if</span> (rm != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(rm, m, m_len);</span><br><span class="line">            *prm_len = m_len;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">    <span class="built_in">OPENSSL_clear_free</span>(encoded, (<span class="type">size_t</span>)encoded_len);</span><br><span class="line">    <span class="built_in">OPENSSL_clear_free</span>(decrypt_buf, siglen);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">RSA_verify</span><span class="params">(<span class="type">int</span> type, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *m, <span class="type">unsigned</span> <span class="type">int</span> m_len,</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *sigbuf, <span class="type">unsigned</span> <span class="type">int</span> siglen, RSA *rsa)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否有自定义校验函数，没有就用默认的，一般引擎会指定</span></span><br><span class="line">    <span class="keyword">if</span> (rsa-&gt;meth-&gt;rsa_verify) &#123;</span><br><span class="line">        <span class="keyword">return</span> rsa-&gt;meth-&gt;<span class="built_in">rsa_verify</span>(type, m, m_len, sigbuf, siglen, rsa);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int_rsa_verify</span>(type, m, m_len, <span class="literal">NULL</span>, <span class="literal">NULL</span>, sigbuf, siglen, rsa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="四、握手流程分析"><a href="#四、握手流程分析" class="headerlink" title="四、握手流程分析"></a>四、握手流程分析</h1><h2 id="1-前置知识"><a href="#1-前置知识" class="headerlink" title="1. 前置知识"></a>1. 前置知识</h2><h3 id="1-1-ssl握手的几个关键点"><a href="#1-1-ssl握手的几个关键点" class="headerlink" title="1.1. ssl握手的几个关键点"></a>1.1. ssl握手的几个关键点</h3><ol><li>密钥交换: 使用RSA密钥交换或ECDHE交换算法</li><li>身份认证: 要求服务端有自己的证书，并且私钥自己持有，过程中会使用私钥签名一段数据给对端使用公钥验签</li><li>对称加密: 上面密钥交换的最后会生成对称加密密钥，作为ssl后续数据传输的加密密钥</li><li>摘要算法: 用于保证数据完整性的算法</li></ol><h3 id="1-2-rsa密钥交换"><a href="#1-2-rsa密钥交换" class="headerlink" title="1.2. rsa密钥交换"></a>1.2. rsa密钥交换</h3><ul><li>客户端产生预主密钥，使用服务端下发的公钥加密后发给服务端</li><li>服务端拿到后，用私钥解密</li><li>双方使用客户端随机数、服务端随机数、预主密钥产生会话密钥通信</li></ul><p><strong>问题</strong></p><ul><li>服务端的私钥如果泄漏，会导致预主密钥泄漏，就可以推断出会话密钥</li></ul><h3 id="1-3-ECC密钥交换"><a href="#1-3-ECC密钥交换" class="headerlink" title="1.3. ECC密钥交换"></a>1.3. ECC密钥交换</h3><ul><li>同rsa，客户端产生预主密钥，使用服务端下发的公钥加密后发给服务端</li></ul><h3 id="1-4-ECDH密钥交换"><a href="#1-4-ECDH密钥交换" class="headerlink" title="1.4. ECDH密钥交换"></a>1.4. ECDH密钥交换</h3><ol><li>本质上是根据<a href="/blogs/2022-03-23-cryptography/#3-ECDHE%E7%AE%97%E6%B3%95">ECC椭圆曲线</a>的算法</li><li>双方首选选择一个椭圆曲线和基点G</li><li>一方生成随机数 $d_1$ 作为私钥，发送给另一方公钥 $Q_1 &#x3D; d_1G$</li><li>同理对方生成随机数 $d_2$ 作为私钥，发送给另一方公钥 $Q_2 &#x3D; d_2G$</li><li>由于当前算力无法推出 $d_1$ 和 $d_2$，所以双方可以直接计算出相同的一个值 $d_1d_2G$ 作为预主密钥</li></ol><p><strong>如何解决rsa的问题</strong></p><ul><li>中间数据传输只有双方的公钥，无法计算出各自的私钥，也无法推断预主密钥</li><li>就算一方私钥泄漏，也不会影响下一次连接，因为私钥是每次重新生成的</li></ul><h3 id="1-5-双证书体系"><a href="#1-5-双证书体系" class="headerlink" title="1.5. 双证书体系"></a>1.5. 双证书体系</h3><ul><li>双证书一般是ukey里面放了一个加密证书和一个签名证书</li><li>签名证书只能用于签名数据，加密证书是用来加密或生成对称加密密钥使用的</li></ul><h4 id="1-客户端ukey"><a href="#1-客户端ukey" class="headerlink" title="1) 客户端ukey"></a>1) 客户端ukey</h4><ul><li>做双向认证时，在Certificate请求构造需要提交签名证书和加密证书，签名证书在加密证书前面</li><li>由于不存在服务端使用客户端公钥加密一段数据给客户端自己解密使用，所以加密证书是用来生成对称加密密钥使用的<ul><li>RSA和ECC密钥交换，由于预主密钥是客户端直接生成给到服务端的，所以不使用加密证书</li><li>ECDHE密钥交换，只能是ECC的加密证书才参与生成</li><li>DHE密钥交换，只能是RSA的加密证书才参与生成</li></ul></li></ul><h2 id="2-重协商流程"><a href="#2-重协商流程" class="headerlink" title="2. 重协商流程"></a>2. 重协商流程</h2><img src="2022-01-24-01.png"><ul><li>199.200.2.170是服务端ip</li></ul><h2 id="3-tls1-2-rsa密钥交换握手过程-Cipher-Suite-TLS-RSA-WITH-AES-256-GCM-SHA384-0x009d"><a href="#3-tls1-2-rsa密钥交换握手过程-Cipher-Suite-TLS-RSA-WITH-AES-256-GCM-SHA384-0x009d" class="headerlink" title="3. tls1.2 rsa密钥交换握手过程 Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d)"></a>3. tls1.2 rsa密钥交换握手过程 <code>Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d)</code></h2><ul><li>下图使用openssl命令测试得到，生成的test.log可以放到wireshark解密</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端</span></span><br><span class="line">openssl s_server -accept 7777 -state -debug -key domain.key -cert domain.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端</span></span><br><span class="line">openssl s_client -connect 127.0.0.1:7777 -tls1_2 -cipher RSA -keylogfile test.log</span><br></pre></td></tr></table></figure><img src="2023-03-24-04.png"><ul><li>使用RSA做密钥交换，使用RSA做身份认证，使用AES256-GCM做对称加密，使用SHA384做摘要算法</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=&gt; openssl ciphers -V | grep -i &#x27;0x00,0x9d&#x27;</span><br><span class="line">0x00,0x9D - AES256-GCM-SHA384       TLSv1.2 Kx=RSA      Au=RSA  Enc=AESGCM(256) Mac=AEAD</span><br></pre></td></tr></table></figure> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1155px" preserveAspectRatio="none" style="width:1334px;height:1155px;background:#fff" version="1.1" viewBox="0 0 1334 1155" width="1334px" zoomAndPan="magnify" class="kroki">$2<defs/><g><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="413" x2="413" y1="36.2969" y2="1120.0703"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="913" x2="913" y1="36.2969" y2="1120.0703"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="388" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="395" y="24.9951">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="388" y="1119.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="395" y="1139.0654">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="885" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="892" y="24.9951">server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="885" y="1119.0703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="892" y="1139.0654">server</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1327" x="0" y="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1327" y1="66.8633" y2="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1327" y1="69.8633" y2="69.8633"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="91" x="618" y="56.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="624" y="72.3638">ssl&#25569;&#25163;&#38454;&#27573;</text><polygon fill="#181818" points="901.5,106.5625,911.5,110.5625,901.5,114.5625,905.5,110.5625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="413.5" x2="907.5" y1="110.5625" y2="110.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="420.5" y="105.4966">Client Hello</text><path d="M190,123.5625 L190,299.5625 L637,299.5625 L637,133.5625 L627,123.5625 L190,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M627,123.5625 L627,133.5625 L637,133.5625 L627,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="196" y="140.6294">client hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="196" y="155.7622">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="426" x="196" y="170.895">Version: TLS 1.0 (0x0301) &#36825;&#20010;&#21487;&#20197;&#24573;&#30053;&#65292;Handshake&#40664;&#35748;&#23601;&#26159;tls1.0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="196" y="186.0278">Handshake Type: Client Hello(1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="212" y="201.1606">Version: TLS 1.2 (0x0303) &#23458;&#25143;&#31471;&#25903;&#25345;&#30340;&#26368;&#39640;tls&#29256;&#26412;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="212" y="216.2935">&#31639;&#27861;&#22871;&#20214;&#20449;&#24687; Cipher Suites</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="228" y="231.4263">&#21253;&#21547;&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#12289;&#36523;&#20221;&#35748;&#35777;&#31639;&#27861;&#12289;&#23545;&#31216;&#21152;&#23494;&#31639;&#27861;&#12289;&#20449;&#24687;&#25688;&#35201;&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="212" y="246.5591">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="228" y="261.6919">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="212" y="276.8247">&#35831;&#27714;&#30340;&#26381;&#21153;&#21517; Extension: server_name(0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="339" x="212" y="291.9575">&#31614;&#21517;&#21704;&#24076;&#31639;&#27861;&#21015;&#34920; Extension: signature_algorithms(13)</text><polygon fill="#181818" points="424.5,322.1563,414.5,326.1563,424.5,330.1563,420.5,326.1563" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="418.5" x2="912.5" y1="326.1563" y2="326.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275" x="430.5" y="321.0903">Server Hello, Certificate, Server Hello Done</text><path d="M758,339.1563 L758,485.1563 L1068,485.1563 L1068,349.1563 L1058,339.1563 L758,339.1563 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1058,339.1563 L1058,349.1563 L1068,349.1563 L1058,339.1563 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="764" y="356.2231">Server Hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="764" y="371.356">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="764" y="386.4888">Handshake Type: Server Hello(2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="764" y="401.6216">&#30830;&#23450;tls&#29256;&#26412; Version</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="764" y="416.7544">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="780" y="431.8872">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="764" y="447.02">&#20250;&#35805;id Session ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="780" y="462.1528">&#29992;&#20110;&#22797;&#29992;&#20250;&#35805;&#65292;&#23458;&#25143;&#31471;&#24102;&#20102;&#23601;&#22797;&#29992;&#65292;&#21542;&#21017;&#23601;&#26032;&#24314;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="764" y="477.2856">&#30830;&#23450;&#31639;&#27861;&#22871;&#20214; Cipher Suite</text><path d="M800,495.3516 L800,580.3516 L1026,580.3516 L1026,505.3516 L1016,495.3516 L800,495.3516 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1016,495.3516 L1016,505.3516 L1026,505.3516 L1016,495.3516 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="806" y="512.4185">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="806" y="527.5513">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="806" y="542.6841">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="806" y="557.8169">&#19979;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="822" y="572.9497">&#21253;&#21547;&#20027;&#39064;&#12289;&#20844;&#38053;&#12289;&#31614;&#21517;&#31639;&#27861;</text><path d="M775,591.0156 L775,661.0156 L1052,661.0156 L1052,601.0156 L1042,591.0156 L775,591.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1042,591.0156 L1042,601.0156 L1052,601.0156 L1042,591.0156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="781" y="608.0825">Server Hello Done</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="781" y="623.2153">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="781" y="638.3481">Handshake Type: Server Hello Done(14)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="781" y="653.481">server hello&#32467;&#26463;</text><polygon fill="#181818" points="901.5,683.6797,911.5,687.6797,901.5,691.6797,905.5,687.6797" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="413.5" x2="907.5" y1="687.6797" y2="687.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="476" x="420.5" y="682.6138">Client Key Exchange, Change Cipher Spec, Enctypted Handshake Message</text><path d="M232,700.6797 L232,770.6797 L594,770.6797 L594,710.6797 L584,700.6797 L232,700.6797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M584,700.6797 L584,710.6797 L594,710.6797 L584,700.6797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="238" y="717.7466">Client Key Exchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="238" y="732.8794">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269" x="238" y="748.0122">Handshake Type: Client Key Exchange(16)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325" x="254" y="763.145">&#29983;&#25104;&#39044;&#20027;&#23494;&#38053;&#65292;&#20351;&#29992;&#26381;&#21153;&#31471;&#19979;&#21457;&#30340;&#20844;&#38053;&#21152;&#23494;&#19978;&#20256;&#21040;&#26381;&#21153;&#31471;</text><path d="M278,781.2109 L278,836.2109 L548,836.2109 L548,791.2109 L538,781.2109 L278,781.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M538,781.2109 L538,791.2109 L548,791.2109 L538,781.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="284" y="798.2778">Change Cipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="284" y="813.4106">Content Type: Change Cipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="300" y="828.5435">&#21578;&#30693;&#26381;&#21153;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M5,846.6094 L5,901.6094 L823,901.6094 L823,856.6094 L813,846.6094 L5,846.6094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M813,846.6094 L813,856.6094 L823,856.6094 L813,846.6094 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="11" y="863.6763">Enctyped Handshake Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="11" y="878.8091">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="781" x="27" y="893.9419">&#20351;&#29992;&#23458;&#25143;&#31471;DH&#21442;&#25968;&#12289;&#26381;&#21153;&#31471;DH&#21442;&#25968;&#29983;&#25104;&#39044;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#23458;&#25143;&#31471;&#38543;&#26426;&#25968;&#12289;&#26381;&#21153;&#31471;&#38543;&#26426;&#25968;&#12289;&#39044;&#20027;&#23494;&#38053;&#29983;&#25104;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#20027;&#23494;&#38053;&#21457;&#36865;&#21152;&#23494;&#25968;&#25454;</text><polygon fill="#181818" points="424.5,924.1406,414.5,928.1406,424.5,932.1406,420.5,928.1406" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="418.5" x2="912.5" y1="928.1406" y2="928.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="430.5" y="923.0747">Change Chipher Spec, Enctypted Handshake Message</text><path d="M774,941.1406 L774,996.1406 L1052,996.1406 L1052,951.1406 L1042,941.1406 L774,941.1406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1042,941.1406 L1042,951.1406 L1052,951.1406 L1042,941.1406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="780" y="958.2075">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="780" y="973.3403">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="796" y="988.4731">&#21578;&#30693;&#23458;&#25143;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M504,1006.5391 L504,1061.5391 L1322,1061.5391 L1322,1016.5391 L1312,1006.5391 L504,1006.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1312,1006.5391 L1312,1016.5391 L1322,1016.5391 L1312,1006.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="510" y="1023.606">Enctyped Handshake Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="510" y="1038.7388">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="781" x="526" y="1053.8716">&#20351;&#29992;&#23458;&#25143;&#31471;DH&#21442;&#25968;&#12289;&#26381;&#21153;&#31471;DH&#21442;&#25968;&#29983;&#25104;&#39044;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#23458;&#25143;&#31471;&#38543;&#26426;&#25968;&#12289;&#26381;&#21153;&#31471;&#38543;&#26426;&#25968;&#12289;&#39044;&#20027;&#23494;&#38053;&#29983;&#25104;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#20027;&#23494;&#38053;&#21457;&#36865;&#21152;&#23494;&#25968;&#25454;</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1327" x="0" y="1087.5039"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1327" y1="1087.5039" y2="1087.5039"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1327" y1="1090.5039" y2="1090.5039"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="117" x="605" y="1076.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="611" y="1093.0044">&#24320;&#22987;ssl&#25968;&#25454;&#20256;&#36755;</text></g></svg><ul><li>密钥交换就是RSA的密钥交换过程</li><li>身份认证在服务端下发Certificate时，客户端会根据是否授信防中间人攻击；而预主密钥又使用了服务端的公钥进行加密传输，只有持有私钥的服务端才能拿到预主密钥，这里也是身份认证的关键</li><li>对称加密和摘要算法就都一样</li></ul><h2 id="4-TLS1-2-ecdhe握手流程-Cipher-Suite-TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384-0xc030"><a href="#4-TLS1-2-ecdhe握手流程-Cipher-Suite-TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384-0xc030" class="headerlink" title="4. TLS1.2 ecdhe握手流程 Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)"></a>4. TLS1.2 ecdhe握手流程 <code>Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)</code></h2><ul><li>使用openssl命令测试，生成的test.log可以放到wireshark解密</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端</span></span><br><span class="line">openssl s_server -accept 7777 -state -debug -key domain.key -cert domain.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端</span></span><br><span class="line">openssl s_client -connect 127.0.0.1:7777 -tls1_2 -cipher ECDHE -keylogfile test.log</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=&gt; openssl ciphers -V | grep -i &#x27;0xc0,0x30&#x27;</span><br><span class="line">0xC0,0x30 - ECDHE-RSA-AES256-GCM-SHA384 TLSv1.2 Kx=ECDH     Au=RSA  Enc=AESGCM(256) Mac=AEAD</span><br></pre></td></tr></table></figure><ul><li>使用ECDHE进行密钥交换，RSA做身份认证，AES256-GCM作为对称加密套件，SHA384作为摘要算法</li><li>ECDHE_RSA是在ECDHE上加了RSA的签名（身份验证），服务端下发keyExchange时会把公钥用RSA私钥签名一下发下来，客户端会使用公钥验证一下签名正确</li></ul><img src="2023-03-21-02.png"> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1276px" preserveAspectRatio="none" style="width:1342px;height:1276px;background:#fff" version="1.1" viewBox="0 0 1342 1276" width="1342px" zoomAndPan="magnify" class="kroki">$2<defs/><g><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="413" x2="413" y1="36.2969" y2="1241.6016"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="921" x2="921" y1="36.2969" y2="1241.6016"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="388" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="395" y="24.9951">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="388" y="1240.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="395" y="1260.5967">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="893" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="900" y="24.9951">server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="893" y="1240.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="900" y="1260.5967">server</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1335" x="0" y="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1335" y1="66.8633" y2="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1335" y1="69.8633" y2="69.8633"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="91" x="622" y="56.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="628" y="72.3638">ssl&#25569;&#25163;&#38454;&#27573;</text><polygon fill="#181818" points="909.5,106.5625,919.5,110.5625,909.5,114.5625,913.5,110.5625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="413.5" x2="915.5" y1="110.5625" y2="110.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="420.5" y="105.4966">Client Hello</text><path d="M198,123.5625 L198,269.5625 L628,269.5625 L628,133.5625 L618,123.5625 L198,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M618,123.5625 L618,133.5625 L628,133.5625 L618,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="204" y="140.6294">client hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="204" y="155.7622">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="204" y="170.895">Handshake Type: Client Hello(1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="220" y="186.0278">&#31639;&#27861;&#22871;&#20214;&#20449;&#24687; Cipher Suites</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="236" y="201.1606">&#21253;&#21547;&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#12289;&#36523;&#20221;&#35748;&#35777;&#31639;&#27861;&#12289;&#23545;&#31216;&#21152;&#23494;&#31639;&#27861;&#12289;&#20449;&#24687;&#25688;&#35201;&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="220" y="216.2935">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="236" y="231.4263">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="220" y="246.5591">&#35831;&#27714;&#30340;&#26381;&#21153;&#21517; Extension: server_name(0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="339" x="220" y="261.6919">&#31614;&#21517;&#21704;&#24076;&#31639;&#27861;&#21015;&#34920; Extension: signature_algorithms(13)</text><polygon fill="#181818" points="424.5,291.8906,414.5,295.8906,424.5,299.8906,420.5,295.8906" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="418.5" x2="920.5" y1="295.8906" y2="295.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="430.5" y="290.8247">Server Hello</text><path d="M758,308.8906 L758,454.8906 L1084,454.8906 L1084,318.8906 L1074,308.8906 L758,308.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1074,308.8906 L1074,318.8906 L1084,318.8906 L1074,308.8906 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="764" y="325.9575">Server Hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="764" y="341.0903">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="764" y="356.2231">Handshake Type: Server Hello(2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="780" y="371.356">&#30830;&#23450;tls&#29256;&#26412; Version</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="780" y="386.4888">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="796" y="401.6216">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="780" y="416.7544">&#20250;&#35805;id Session ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="796" y="431.8872">&#29992;&#20110;&#22797;&#29992;&#20250;&#35805;&#65292;&#23458;&#25143;&#31471;&#24102;&#20102;&#23601;&#22797;&#29992;&#65292;&#21542;&#21017;&#23601;&#26032;&#24314;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="780" y="447.02">&#30830;&#23450;&#31639;&#27861;&#22871;&#20214; Cipher Suite</text><polygon fill="#181818" points="424.5,477.2188,414.5,481.2188,424.5,485.2188,420.5,481.2188" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="418.5" x2="920.5" y1="481.2188" y2="481.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="332" x="430.5" y="476.1528">Certificate, Server Key Exchange, Server Hello Done</text><path d="M808,494.2188 L808,579.2188 L1034,579.2188 L1034,504.2188 L1024,494.2188 L808,494.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1024,494.2188 L1024,504.2188 L1034,504.2188 L1024,494.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="814" y="511.2856">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="814" y="526.4185">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="814" y="541.5513">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="830" y="556.6841">&#19979;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="830" y="571.8169">&#21253;&#21547;&#20027;&#39064;&#12289;&#20844;&#38053;&#12289;&#31614;&#21517;&#31639;&#27861;</text><path d="M616,589.8828 L616,659.8828 L1227,659.8828 L1227,599.8828 L1217,589.8828 L616,589.8828 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1217,589.8828 L1217,599.8828 L1227,599.8828 L1217,589.8828 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="622" y="606.9497">Server Key Exchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="622" y="622.0825">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275" x="622" y="637.2153">Handshake Type: Server Key Exchange(12)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="574" x="638" y="652.3481">&#20351;&#29992;ECDHE&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#25165;&#26377;&#30340;&#26381;&#21153;&#31471;key&#19979;&#21457;&#65307;&#26925;&#22278;&#31867;&#22411;&#12289;&#20844;&#38053;&#65292;&#20351;&#29992;&#26381;&#21153;&#31471;&#35777;&#20070;&#30340;&#31169;&#38053;&#36827;&#34892;&#31614;&#21517;</text><path d="M783,670.4141 L783,740.4141 L1060,740.4141 L1060,680.4141 L1050,670.4141 L783,670.4141 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1050,670.4141 L1050,680.4141 L1060,680.4141 L1050,670.4141 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="789" y="687.481">Server Hello Done</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="789" y="702.6138">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="789" y="717.7466">Handshake Type: Server Hello Done(14)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="789" y="732.8794">server hello&#32467;&#26463;</text><polygon fill="#181818" points="909.5,763.0781,919.5,767.0781,909.5,771.0781,913.5,767.0781" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="413.5" x2="915.5" y1="767.0781" y2="767.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="484" x="420.5" y="762.0122">Client Key Exchange, Change Chipher Spec, Enctypted Handshake Message</text><line style="stroke:#181818;stroke-width:1" x1="413.5" x2="455.5" y1="796.2109" y2="796.2109"/><line style="stroke:#181818;stroke-width:1" x1="455.5" x2="455.5" y1="796.2109" y2="809.2109"/><line style="stroke:#181818;stroke-width:1" x1="414.5" x2="455.5" y1="809.2109" y2="809.2109"/><polygon fill="#181818" points="424.5,805.2109,414.5,809.2109,424.5,813.2109,420.5,809.2109" style="stroke:#181818;stroke-width:1"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="420.5" y="791.145">&#29983;&#25104;&#23458;&#25143;&#31471;DH&#21442;&#25968;</text><path d="M268,822.2109 L268,892.2109 L558,892.2109 L558,832.2109 L548,822.2109 L268,822.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M548,822.2109 L548,832.2109 L558,832.2109 L548,822.2109 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="274" y="839.2778">Client Key Exchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="274" y="854.4106">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269" x="274" y="869.5435">Handshake Type: Client Key Exchange(16)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="290" y="884.6763">&#21457;&#36865;&#23458;&#25143;&#31471;&#30340;DH&#21442;&#25968;&#65292;&#26126;&#25991;&#21457;&#36865;</text><path d="M274,902.7422 L274,957.7422 L552,957.7422 L552,912.7422 L542,902.7422 L274,902.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M542,902.7422 L542,912.7422 L552,912.7422 L542,902.7422 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="280" y="919.8091">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="280" y="934.9419">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="296" y="950.0747">&#21578;&#30693;&#26381;&#21153;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M5,968.1406 L5,1023.1406 L823,1023.1406 L823,978.1406 L813,968.1406 L5,968.1406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M813,968.1406 L813,978.1406 L823,978.1406 L813,968.1406 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="11" y="985.2075">Enctyped Handshake Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="11" y="1000.3403">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="781" x="27" y="1015.4731">&#20351;&#29992;&#23458;&#25143;&#31471;DH&#21442;&#25968;&#12289;&#26381;&#21153;&#31471;DH&#21442;&#25968;&#29983;&#25104;&#39044;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#23458;&#25143;&#31471;&#38543;&#26426;&#25968;&#12289;&#26381;&#21153;&#31471;&#38543;&#26426;&#25968;&#12289;&#39044;&#20027;&#23494;&#38053;&#29983;&#25104;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#20027;&#23494;&#38053;&#21457;&#36865;&#21152;&#23494;&#25968;&#25454;</text><polygon fill="#181818" points="424.5,1045.6719,414.5,1049.6719,424.5,1053.6719,420.5,1049.6719" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="418.5" x2="920.5" y1="1049.6719" y2="1049.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="347" x="430.5" y="1044.606">Change Chipher Spec, Enctypted Handshake Message</text><path d="M782,1062.6719 L782,1117.6719 L1060,1117.6719 L1060,1072.6719 L1050,1062.6719 L782,1062.6719 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1050,1062.6719 L1050,1072.6719 L1060,1072.6719 L1050,1062.6719 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="788" y="1079.7388">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="788" y="1094.8716">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="788" y="1110.0044">&#21578;&#30693;&#23458;&#25143;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M512,1128.0703 L512,1183.0703 L1330,1183.0703 L1330,1138.0703 L1320,1128.0703 L512,1128.0703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1320,1128.0703 L1320,1138.0703 L1330,1138.0703 L1320,1128.0703 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="518" y="1145.1372">Enctyped Handshake Message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="518" y="1160.27">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="781" x="534" y="1175.4028">&#20351;&#29992;&#23458;&#25143;&#31471;DH&#21442;&#25968;&#12289;&#26381;&#21153;&#31471;DH&#21442;&#25968;&#29983;&#25104;&#39044;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#23458;&#25143;&#31471;&#38543;&#26426;&#25968;&#12289;&#26381;&#21153;&#31471;&#38543;&#26426;&#25968;&#12289;&#39044;&#20027;&#23494;&#38053;&#29983;&#25104;&#20027;&#23494;&#38053;&#65307;&#20351;&#29992;&#20027;&#23494;&#38053;&#21457;&#36865;&#21152;&#23494;&#25968;&#25454;</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1335" x="0" y="1209.0352"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1335" y1="1209.0352" y2="1209.0352"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1335" y1="1212.0352" y2="1212.0352"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="117" x="609" y="1198.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="615" y="1214.5356">&#24320;&#22987;ssl&#25968;&#25454;&#20256;&#36755;</text></g></svg><ul><li>密钥交换就是ECDHE的密钥交换过程</li><li>身份认证在服务端下发Certificate时，客户端会根据是否授信防中间人攻击；在服务端下发<code>Server Key Exchange</code>时会使用私钥进行签名，客户端使用下发的公钥进行验签就保证了私钥是服务端持有的，其他人无法进行签名</li><li>对称加密和摘要算法就都一样</li></ul><h2 id="5-TLS1-3-握手流程-TLS-AES-256-GCM-SHA384-0x1302"><a href="#5-TLS1-3-握手流程-TLS-AES-256-GCM-SHA384-0x1302" class="headerlink" title="5. TLS1.3 握手流程 TLS_AES_256_GCM_SHA384(0x1302)"></a>5. TLS1.3 握手流程 <code>TLS_AES_256_GCM_SHA384(0x1302)</code></h2><ul><li>使用openssl命令测试，生成的test.log可以放到wireshark解密</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端</span></span><br><span class="line">openssl s_server -accept 7777 -state -debug -key domain.key -cert domain.crt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端</span></span><br><span class="line">openssl s_client -connect 127.0.0.1:7777 -tls1_3 -cipher ECDHE -keylogfile test.log</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=&gt; openssl ciphers -V | grep &#x27;0x13,0x02&#x27;</span><br><span class="line">0x13,0x02 - TLS_AES_256_GCM_SHA384  TLSv1.3 Kx=any      Au=any  Enc=AESGCM(256) Mac=AEAD</span><br></pre></td></tr></table></figure><ul><li>使用ECDHE进行密钥交换，AES256-GCM作为对称加密套件，SHA384作为摘要算法</li></ul><img src="2023-03-24-03.png"><ul><li>上面抓包是解密的数据，所以能看到内容，正常<code>Change Chipher Spec</code>后，后面的数据都是加密的</li></ul> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1428px" preserveAspectRatio="none" style="width:1247px;height:1428px;background:#fff" version="1.1" viewBox="0 0 1247 1428" width="1247px" zoomAndPan="magnify" class="kroki">$2<defs/><g><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="246" x2="246" y1="36.2969" y2="1393.5938"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="877" x2="877" y1="36.2969" y2="1393.5938"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="221" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="228" y="24.9951">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="221" y="1392.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="228" y="1412.5889">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="849" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="856" y="24.9951">server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="849" y="1392.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="856" y="1412.5889">server</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1240" x="0" y="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1240" y1="66.8633" y2="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1240" y1="69.8633" y2="69.8633"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="91" x="574.5" y="56.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="580.5" y="72.3638">ssl&#25569;&#25163;&#38454;&#27573;</text><polygon fill="#181818" points="865.5,106.5625,875.5,110.5625,865.5,114.5625,869.5,110.5625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="246.5" x2="871.5" y1="110.5625" y2="110.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="253.5" y="105.4966">Client Hello</text><path d="M5,123.5625 L5,359.5625 L488,359.5625 L488,133.5625 L478,123.5625 L5,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M478,123.5625 L478,133.5625 L488,133.5625 L478,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="11" y="140.6294">client hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="11" y="155.7622">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="11" y="170.895">Handshake Type: Client Hello(1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="454" x="19" y="186.0278">Version TLS 1.2 (0x0303) &#34429;&#28982;&#26159;tls1.2&#23454;&#38469;&#35201;&#30475;&#21518;&#38754;&#30340;supported_versions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="19" y="201.1606">&#31639;&#27861;&#22871;&#20214;&#20449;&#24687; Cipher Suites</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="35" y="216.2935">&#21253;&#21547;&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#12289;&#36523;&#20221;&#35748;&#35777;&#31639;&#27861;&#12289;&#23545;&#31216;&#21152;&#23494;&#31639;&#27861;&#12289;&#20449;&#24687;&#25688;&#35201;&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="19" y="231.4263">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="35" y="246.5591">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="19" y="261.6919">tls&#25903;&#25345;&#30340;&#29256;&#26412; Extensions: supported_versions(43)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="19" y="276.8247">&#35831;&#27714;&#30340;&#26381;&#21153;&#21517; Extension: server_name(0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="339" x="19" y="291.9575">&#31614;&#21517;&#21704;&#24076;&#31639;&#27861;&#21015;&#34920; Extension: signature_algorithms(13)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="19" y="307.0903">&#23494;&#38053;&#20132;&#25442; Extension: key_share(51)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="35" y="322.2231">&#21457;&#36865;&#23458;&#25143;&#31471;&#20844;&#38053;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="349" x="19" y="337.356">&#23494;&#38053;&#20132;&#25442;&#27169;&#24335; Extension: psk_key_exchange_modes(45)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="35" y="352.4888">&#23494;&#38053;&#20132;&#25442;&#27169;&#24335;&#65292;&#35265;&#19979;&#26041;&#35299;&#37322;</text><polygon fill="#181818" points="257.5,382.6875,247.5,386.6875,257.5,390.6875,253.5,386.6875" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="251.5" x2="876.5" y1="386.6875" y2="386.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="607" x="263.5" y="381.6216">Server Hello, Change Cipher Spec, Encrypted Extensions, Certificate, Certificate Verify, Finished</text><path d="M629,399.6875 L629,590.6875 L1125,590.6875 L1125,409.6875 L1115,399.6875 L629,399.6875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1115,399.6875 L1115,409.6875 L1125,409.6875 L1115,399.6875 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="635" y="416.7544">Server Hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="635" y="431.8872">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="635" y="447.02">Handshake Type: Server Hello(2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="651" y="462.1528">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="667" y="477.2856">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="651" y="492.4185">&#20250;&#35805;id Session ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="667" y="507.5513">&#29992;&#20110;&#22797;&#29992;&#20250;&#35805;&#65292;&#23458;&#25143;&#31471;&#24102;&#20102;&#23601;&#22797;&#29992;&#65292;&#21542;&#21017;&#23601;&#26032;&#24314;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="651" y="522.6841">&#30830;&#23450;&#31639;&#27861;&#22871;&#20214; Cipher Suite</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="651" y="537.8169">&#23494;&#38053;&#20132;&#25442; Extension: key_share(51)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="667" y="552.9497">&#21457;&#36865;&#26381;&#21153;&#31471;&#20844;&#38053;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="651" y="568.0825">tls&#25903;&#25345;&#29256;&#26412; Extensions: supported_versions(43)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="443" x="667" y="583.2153">&#22238;&#22797;&#23458;&#25143;&#31471;&#27492;&#23383;&#27573;&#65292;&#20195;&#34920;&#25903;&#25345;tls1.3&#29256;&#26412;&#24182;&#36873;&#25321;tls1.3&#65292;tls1.2&#19981;&#20250;&#22238;&#22797;&#27492;&#25299;&#23637;</text><path d="M742,601.2813 L742,656.2813 L1012,656.2813 L1012,611.2813 L1002,601.2813 L742,601.2813 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1002,601.2813 L1002,611.2813 L1012,611.2813 L1002,601.2813 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="748" y="618.3481">Change Cipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="748" y="633.481">Content Type: Change Cipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="748" y="648.6138">&#21578;&#30693;&#23458;&#25143;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M695,666.6797 L695,766.6797 L1059,766.6797 L1059,676.6797 L1049,666.6797 L695,666.6797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1049,666.6797 L1049,676.6797 L1059,676.6797 L1049,666.6797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="701" y="683.7466">Encrypted Extensions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="701" y="698.8794">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="701" y="714.0122">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="701" y="729.145">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="701" y="744.2778">Handshake Type: Encrypted Extension(8)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="343" x="701" y="759.4106">&#19968;&#33324;&#32473;&#30340;&#26159;&#19979;&#19968;&#23618;&#30340;&#21327;&#35758;&#31867;&#22411;&#65292;&#22914;ALPH Protocol: http/1.1</text><path d="M755,777.4766 L755,908.4766 L999,908.4766 L999,787.4766 L989,777.4766 L755,777.4766 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M989,777.4766 L989,787.4766 L999,787.4766 L989,777.4766 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="761" y="794.5435">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="761" y="809.6763">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="761" y="824.8091">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="761" y="839.9419">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="761" y="855.0747">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="761" y="870.2075">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="761" y="885.3403">&#19979;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="761" y="900.4731">&#21253;&#21547;&#20027;&#39064;&#12289;&#20844;&#38053;&#12289;&#31614;&#21517;&#31639;&#27861;</text><path d="M519,918.5391 L519,1018.5391 L1235,1018.5391 L1235,928.5391 L1225,918.5391 L519,918.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1225,918.5391 L1225,928.5391 L1235,928.5391 L1225,918.5391 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="525" y="935.606">Certificate Verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="525" y="950.7388">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="541" y="965.8716">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="525" y="981.0044">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="541" y="996.1372">Handshake Type: Certificate Verify(15)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="663" x="557" y="1011.27">&#26381;&#21153;&#31471;&#20351;&#29992;&#35777;&#20070;&#31169;&#38053;&#23545;&#35777;&#20070;&#21069;&#30340;&#25152;&#26377;&#25569;&#25163;&#25968;&#25454;&#25688;&#35201;&#21518;&#36827;&#34892;&#31614;&#21517;&#65292;&#35777;&#26126;&#35777;&#20070;&#26159;&#33258;&#24049;&#25345;&#26377;&#30340;&#65292;&#23458;&#25143;&#31471;&#20250;&#20351;&#29992;&#20844;&#38053;&#36827;&#34892;&#39564;&#35777;</text><path d="M755,1029.3359 L755,1129.3359 L999,1129.3359 L999,1039.3359 L989,1029.3359 L755,1029.3359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M989,1029.3359 L989,1039.3359 L999,1039.3359 L989,1029.3359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="761" y="1046.4028">Finished</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="761" y="1061.5356">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="761" y="1076.6685">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="761" y="1091.8013">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="761" y="1106.9341">Handshake Type: Finished(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="761" y="1122.0669">server hello&#32467;&#26463;</text><polygon fill="#181818" points="865.5,1152.2656,875.5,1156.2656,865.5,1160.2656,869.5,1156.2656" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="246.5" x2="871.5" y1="1156.2656" y2="1156.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="198" x="253.5" y="1151.1997">Change Chipher Spec, Finished</text><path d="M107,1169.2656 L107,1224.2656 L385,1224.2656 L385,1179.2656 L375,1169.2656 L107,1169.2656 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M375,1169.2656 L375,1179.2656 L385,1179.2656 L375,1169.2656 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="113" y="1186.3325">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="113" y="1201.4653">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="113" y="1216.5981">&#21578;&#30693;&#26381;&#21153;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M124,1234.6641 L124,1334.6641 L368,1334.6641 L368,1244.6641 L358,1234.6641 L124,1234.6641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M358,1234.6641 L358,1244.6641 L368,1244.6641 L358,1234.6641 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="130" y="1251.731">Finished</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="130" y="1266.8638">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="130" y="1281.9966">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="130" y="1297.1294">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="130" y="1312.2622">Handshake Type: Finished(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="130" y="1327.395">server hello&#32467;&#26463;</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1240" x="0" y="1361.0273"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1240" y1="1361.0273" y2="1361.0273"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1240" y1="1364.0273" y2="1364.0273"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="117" x="561.5" y="1350.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="567.5" y="1366.5278">&#24320;&#22987;ssl&#25968;&#25454;&#20256;&#36755;</text></g></svg><ul><li>密钥交换就是ECDHE的密钥交换过程</li><li>身份认证在服务端下发Certificate时，客户端会根据是否授信防中间人攻击；在服务端下发<code>Certificate Verify</code>时会使用私钥对前面的握手信息进行签名，客户端验签通过说明是持有私钥的服务端下发的数据，做身份认证</li><li>这里和tls1.2中不一样的地方就是tls1.3没有<code>Server Key Exchange</code>请求了，DH参数在<code>Server Hello</code>中就下发了，这时没有证书信息下发，所以不进行签名。可以进行加密传输后，再使用<code>Certificate Verify</code>来保证私钥是服务端持有的</li><li>对称加密和摘要算法就都一样</li></ul><h3 id="5-1-握手过程解释"><a href="#5-1-握手过程解释" class="headerlink" title="5.1. 握手过程解释"></a>5.1. 握手过程解释</h3><ul><li>在client hello阶段就已经客户端选择好密钥交换算法并给出了自己的公钥信息<ul><li>client hello中的version虽然写的tls1.2，是因为历史原因，只能写tls1.2，实际支持版本是拓展中的supported_versions字段给出的</li><li>由于很多服务器或网关设备写死了tls版本必须是tls1.2，tls1.3为了推行而不改变网络部署，伪装到tls1.2中进行传输，所以version为1.2</li><li>支持tls1.3的客户端在client hello中一定会有supported_versions的拓展</li></ul></li><li>server hello阶段给出了服务端的公钥信息，这个时候双方都持有了对方的公钥<ul><li>server hello中的version虽然写的tls1.2，也是因为历史原因，只能写tls1.2。具体选择的版本要看后面拓展的supported_versions的回复</li><li>不支持tls1.3的服务端不会回复supported_versions的拓展</li></ul></li><li>使用双方公钥和双方随机数就可以计算出预主密钥，这一步就已经可以加密传输了</li><li>这里比tls1.2少了一个rtt，加快速度</li><li>使用ecdh进行密钥交换，也比rsa更加安全</li><li>tls1.3不再支持rsa的密钥交换算法了，默认使用ecdhe的方式交换</li><li>身份认证是在<code>Certificate Verify</code>中进行，根据证书的算法使用私钥对握手数据进行签名，客户端使用公钥校验证明是服务端持有私钥</li></ul><h3 id="5-2-psk-key-exchange-modes"><a href="#5-2-psk-key-exchange-modes" class="headerlink" title="5.2. psk_key_exchange_modes"></a>5.2. psk_key_exchange_modes</h3><p>psk_key_exchange_modes是一种TLS协议中的扩展，用于指定预共享密钥（PSK）交换的模式。根据TLS 1.3规范，psk_key_exchange_modes共有4种模式，分别为：</p><ul><li>PSK with (EC)DHE key establishment：使用预共享密钥和(Elliptic Curve)有限域Diffie-Hellman(ECDHE)密钥交换。</li><li>PSK with (EC)DHE key establishment, and PFS：使用预共享密钥和(Elliptic Curve)有限域Diffie-Hellman(ECDHE)密钥交换，并提供前向保密性（Perfect Forward Secrecy，PFS）。</li><li>PSK with (EC)DHE key establishment, and PFS with early data：使用预共享密钥和(Elliptic Curve)有限域Diffie-Hellman(ECDHE)密钥交换，并提供PFS和早期数据传输。</li><li>PSK without (EC)DHE key establishment (i.e., 0-RTT)：仅使用预共享密钥进行握手，不进行(Elliptic Curve)有限域Diffie-Hellman(ECDHE)密钥交换，从而实现0-RTT握手。</li></ul><h2 id="6-双向认证流程"><a href="#6-双向认证流程" class="headerlink" title="6. 双向认证流程"></a>6. 双向认证流程</h2><h3 id="6-1-tls1-2的rsa证书双向认证"><a href="#6-1-tls1-2的rsa证书双向认证" class="headerlink" title="6.1. tls1.2的rsa证书双向认证"></a>6.1. tls1.2的rsa证书双向认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端命令</span></span><br><span class="line">openssl s_server -accept 7777 -state -debug -key domain.key -cert domain.crt -CAfile cacert.pem -Verify 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端命令</span></span><br><span class="line">openssl s_client -connect 127.0.0.1:7777 -cipher RSA -tls1_2 -debug -keylogfile test.log -cert domain.crt -key domain.key</span><br></pre></td></tr></table></figure><p><img src="/2023-06-19-01.png"></p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1772px" preserveAspectRatio="none" style="width:1359px;height:1772px;background:#fff" version="1.1" viewBox="0 0 1359 1772" width="1359px" zoomAndPan="magnify" class="kroki">$2<defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="167" x="592" y="27.9951">tls1.2&#30340;rsa&#35777;&#20070;&#21452;&#21521;&#35748;&#35777;</text><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="401" x2="401" y1="73.5938" y2="1736.75"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="1087" x2="1087" y1="73.5938" y2="1736.75"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="376" y="42.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="383" y="62.292">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="376" y="1735.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="383" y="1755.7451">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="1059" y="42.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="1066" y="62.292">server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="1059" y="1735.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="1066" y="1755.7451">server</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1352" x="0" y="104.1602"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1352" y1="104.1602" y2="104.1602"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1352" y1="107.1602" y2="107.1602"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="108" x="622" y="93.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="89" x="628" y="109.6606">tcp&#24314;&#31435;&#23436;&#25104;&#21518;</text><polygon fill="#181818" points="1075.5,143.8594,1085.5,147.8594,1075.5,151.8594,1079.5,147.8594" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="401.5" x2="1081.5" y1="147.8594" y2="147.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="408.5" y="142.7935">Client Hello</text><path d="M178,160.8594 L178,336.8594 L625,336.8594 L625,170.8594 L615,160.8594 L178,160.8594 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M615,160.8594 L615,170.8594 L625,170.8594 L615,160.8594 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="184" y="177.9263">client hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="184" y="193.0591">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="426" x="184" y="208.1919">Version: TLS 1.0 (0x0301) &#36825;&#20010;&#21487;&#20197;&#24573;&#30053;&#65292;Handshake&#40664;&#35748;&#23601;&#26159;tls1.0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="184" y="223.3247">Handshake Type: Client Hello(1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="317" x="200" y="238.4575">Version: TLS 1.2 (0x0303) &#23458;&#25143;&#31471;&#25903;&#25345;&#30340;&#26368;&#39640;tls&#29256;&#26412;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="200" y="253.5903">&#31639;&#27861;&#22871;&#20214;&#20449;&#24687; Cipher Suites</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="216" y="268.7231">&#21253;&#21547;&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#12289;&#36523;&#20221;&#35748;&#35777;&#31639;&#27861;&#12289;&#23545;&#31216;&#21152;&#23494;&#31639;&#27861;&#12289;&#20449;&#24687;&#25688;&#35201;&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="200" y="283.856">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="216" y="298.9888">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="200" y="314.1216">&#35831;&#27714;&#30340;&#26381;&#21153;&#21517; Extension: server_name(0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="339" x="200" y="329.2544">&#31614;&#21517;&#21704;&#24076;&#31639;&#27861;&#21015;&#34920; Extension: signature_algorithms(13)</text><polygon fill="#181818" points="412.5,359.4531,402.5,363.4531,412.5,367.4531,408.5,363.4531" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="406.5" x2="1086.5" y1="363.4531" y2="363.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="404" x="418.5" y="358.3872">Server Hello, Certificate, Certificate Request, Server Hello Done</text><path d="M827,376.4531 L827,507.4531 L1347,507.4531 L1347,386.4531 L1337,376.4531 L827,376.4531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1337,376.4531 L1337,386.4531 L1347,386.4531 L1337,376.4531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="833" y="393.52">Server Hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="833" y="408.6528">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="833" y="423.7856">Handshake Type: Server Hello(2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="849" y="438.9185">Version: TLS 1.2 (0x0303) &#30830;&#23450;TLS&#29256;&#26412;&#20026;1.2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="849" y="454.0513">Random &#38543;&#26426;&#25968;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="865" y="469.1841">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="483" x="849" y="484.3169">Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d) &#30830;&#23450;&#31639;&#27861;&#22871;&#20214;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="833" y="499.4497">&#160;</text><path d="M944,517.5156 L944,602.5156 L1231,602.5156 L1231,527.5156 L1221,517.5156 L944,517.5156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1221,517.5156 L1221,527.5156 L1231,527.5156 L1221,517.5156 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="950" y="534.5825">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="950" y="549.7153">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="950" y="564.8481">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="966" y="579.981">&#19979;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="982" y="595.1138">&#21253;&#21547;&#35777;&#20070;&#20449;&#24687;&#12289;&#35777;&#20070;&#20844;&#38053;&#12289;&#35777;&#20070;&#31614;&#21517;&#20449;&#24687;</text><path d="M838,613.1797 L838,774.1797 L1336,774.1797 L1336,623.1797 L1326,613.1797 L838,613.1797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1326,613.1797 L1326,623.1797 L1336,623.1797 L1326,613.1797 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="844" y="630.2466">Certificate Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="844" y="645.3794">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="844" y="660.5122">Handshake Type: Certificate Request (13)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="860" y="675.645">&#35201;&#27714;&#23458;&#25143;&#31471;&#25552;&#20132;&#35777;&#20070;&#65292;&#19968;&#33324;&#26159;nginx&#37197;&#32622;&#20013;&#24320;&#21551;&#20102;&#23545;&#31471;&#35777;&#20070;&#26657;&#39564;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="286" x="860" y="690.7778">Certificate types (3 types) &#20801;&#35768;&#25552;&#20132;&#30340;&#35777;&#20070;&#31867;&#22411;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="876" y="705.9106">RSA Sign</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="876" y="721.0435">DSS Sign</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="876" y="736.1763">ECDSA Sign</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413" x="860" y="751.3091">Signature Hash Algorithms (23 algorithms) &#25903;&#25345;&#30340;&#31614;&#21517;&#21644;hash&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="461" x="860" y="766.4419">Distinguished Names (135 bytes) CA&#30456;&#20851;&#20449;&#24687;&#65292;&#21482;&#25903;&#25345;&#27492;CA&#19979;&#21457;&#30340;&#30456;&#20851;&#35777;&#20070;</text><path d="M949,784.5078 L949,854.5078 L1226,854.5078 L1226,794.5078 L1216,784.5078 L949,784.5078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1216,784.5078 L1216,794.5078 L1226,794.5078 L1216,784.5078 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="955" y="801.5747">Server Hello Done</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="955" y="816.7075">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="256" x="955" y="831.8403">Handshake Type: Server Hello Done(14)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="955" y="846.9731">server hello&#32467;&#26463;</text><polygon fill="#181818" points="1075.5,877.1719,1085.5,881.1719,1075.5,885.1719,1079.5,881.1719" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="401.5" x2="1081.5" y1="881.1719" y2="881.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="662" x="408.5" y="876.106">Certificate, Client Key Exchange, Certificate Verify, Change Cipher Spec, Encrypted Handshake Message</text><path d="M5,894.1719 L5,1085.1719 L798,1085.1719 L798,904.1719 L788,894.1719 L5,894.1719 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M788,894.1719 L788,904.1719 L798,904.1719 L788,894.1719 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="11" y="911.2388">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="11" y="926.3716">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="11" y="941.5044">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="27" y="956.6372">&#25552;&#20132;&#23458;&#25143;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="27" y="971.77">Certificates (2043 bytes) &#35777;&#20070;&#20449;&#24687;&#38598;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="151" x="43" y="986.9028">Certificate: &#21333;&#20010;&#35777;&#20070;&#20449;&#24687;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="202" x="59" y="1002.0356">signedCertificate &#35777;&#20070;&#30340;&#22522;&#26412;&#20449;&#24687;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="75" y="1017.1685">subject &#20027;&#39064;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="185" x="75" y="1032.3013">subjectPublicKeyInfo &#20844;&#38053;&#20449;&#24687;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="75" y="1047.4341">validity &#35777;&#20070;&#26377;&#25928;&#26399;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="59" y="1062.5669">algorithmIdentifier (sha256WithRSAEncryption)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="724" x="59" y="1077.6997">encrypted: &#35777;&#20070;&#31614;&#21517;&#20540;&#65288;&#27599;&#20010;&#35777;&#20070;&#37117;&#33258;&#24102;&#65288;&#31614;&#21457;&#26102;&#20351;&#29992;&#31169;&#38053;&#21152;&#23494;&#25688;&#35201;&#20449;&#24687;&#31639;&#20986;&#26469;&#30340;&#65289;&#65292;&#29992;&#20110;&#38450;&#31713;&#25913;&#65292;&#19981;&#26159;tls&#36807;&#31243;&#20013;&#31639;&#20986;&#26469;&#30340;&#65289;</text><path d="M32,1095.7656 L32,1165.7656 L771,1165.7656 L771,1105.7656 L761,1095.7656 L32,1095.7656 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M761,1095.7656 L761,1105.7656 L771,1105.7656 L761,1095.7656 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="38" y="1112.8325">Client Key Exchange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="38" y="1127.9653">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269" x="38" y="1143.0981">Handshake Type: Client Key Exchange(16)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="702" x="54" y="1158.231">&#29983;&#25104;&#39044;&#20027;&#23494;&#38053;&#65292;&#20351;&#29992;&#26381;&#21153;&#31471;&#19979;&#21457;&#30340;&#20844;&#38053;&#21152;&#23494;&#19978;&#20256;&#21040;&#26381;&#21153;&#31471;&#65292;&#30001;&#20110;&#21482;&#26377;&#26381;&#21153;&#31471;&#33258;&#24049;&#26377;&#31169;&#38053;&#36825;&#19968;&#27493;&#20445;&#35777;&#35777;&#20070;&#26159;&#26381;&#21153;&#31471;&#33258;&#24049;&#25345;&#26377;&#30340;</text><path d="M110,1176.2969 L110,1246.2969 L693,1246.2969 L693,1186.2969 L683,1176.2969 L110,1176.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M683,1176.2969 L683,1186.2969 L693,1186.2969 L683,1176.2969 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="116" y="1193.3638">Certificate Verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="116" y="1208.4966">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="116" y="1223.6294">Handshake Type: Certificate Verify (15)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="546" x="132" y="1238.7622">&#20351;&#29992;&#23458;&#25143;&#31471;&#35777;&#20070;&#30340;&#31169;&#38053;&#23545;&#25569;&#25163;&#20449;&#24687;&#36827;&#34892;&#31614;&#21517;&#65292;&#30001;&#26381;&#21153;&#31471;&#36827;&#34892;&#39564;&#31614;&#26469;&#30830;&#23450;&#35777;&#20070;&#26159;&#23458;&#25143;&#31471;&#33258;&#24049;&#25345;&#26377;&#30340;</text><path d="M262,1256.8281 L262,1311.8281 L540,1311.8281 L540,1266.8281 L530,1256.8281 L262,1256.8281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M530,1256.8281 L530,1266.8281 L540,1266.8281 L530,1256.8281 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="268" y="1273.895">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="268" y="1289.0278">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="284" y="1304.1606">&#21578;&#30693;&#26381;&#21153;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M279,1322.2266 L279,1407.2266 L523,1407.2266 L523,1332.2266 L513,1322.2266 L279,1322.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M513,1322.2266 L513,1332.2266 L523,1332.2266 L513,1322.2266 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="285" y="1339.2935">Finished</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="285" y="1354.4263">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="301" y="1369.5591">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="301" y="1384.6919">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="301" y="1399.8247">Handshake Type: Finished(20)</text><polygon fill="#181818" points="412.5,1430.0234,402.5,1434.0234,412.5,1438.0234,408.5,1434.0234" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="406.5" x2="1086.5" y1="1434.0234" y2="1434.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="320" x="418.5" y="1428.9575">New Session Ticket, Change Cipher Spec, Finished</text><path d="M948,1447.0234 L948,1517.0234 L1227,1517.0234 L1227,1457.0234 L1217,1447.0234 L948,1447.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1217,1447.0234 L1217,1457.0234 L1227,1457.0234 L1217,1447.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="954" y="1464.0903">New Session Ticket</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="954" y="1479.2231">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="258" x="954" y="1494.356">Handshake Type: New Session Ticket (4)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="970" y="1509.4888">&#32473;&#19968;&#20010;session&#21040;&#23458;&#25143;&#31471;&#65292;&#29992;&#20110;ssl&#22797;&#29992;</text><path d="M948,1527.5547 L948,1582.5547 L1226,1582.5547 L1226,1537.5547 L1216,1527.5547 L948,1527.5547 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1216,1527.5547 L1216,1537.5547 L1226,1537.5547 L1216,1527.5547 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="954" y="1544.6216">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="954" y="1559.7544">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="970" y="1574.8872">&#21578;&#30693;&#23458;&#25143;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M965,1592.9531 L965,1677.9531 L1209,1677.9531 L1209,1602.9531 L1199,1592.9531 L965,1592.9531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1199,1592.9531 L1199,1602.9531 L1209,1602.9531 L1199,1592.9531 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="971" y="1610.02">Finished</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="971" y="1625.1528">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="987" y="1640.2856">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="987" y="1655.4185">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="987" y="1670.5513">Handshake Type: Finished(20)</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1352" x="0" y="1704.1836"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1352" y1="1704.1836" y2="1704.1836"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1352" y1="1707.1836" y2="1707.1836"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="117" x="617.5" y="1693.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="623.5" y="1709.6841">&#24320;&#22987;ssl&#25968;&#25454;&#20256;&#36755;</text></g></svg><h4 id="1-防中间人处理"><a href="#1-防中间人处理" class="headerlink" title="1) 防中间人处理"></a>1) 防中间人处理</h4><ul><li>中间人一般是使用ssl代理，搭建ssl服务器，客户端是和代理服务器进行握手，代理服务器作为客户端和服务端进行握手，防中间人就是确认中间没有ssl代理服务器</li><li>公开的信息（抓包都能拿到的）: 服务端证书（包含公钥、证书签名信息）、客户端证书（包含公钥、证书签名信息）</li><li>签名的信息: 客户端使用私钥签名握手数据</li><li>加密的信息: 客户端将预主密钥通过服务端证书的公钥加密</li></ul><h5 id="1-客户端如何确认服务端是没问题的（防服务端伪造）"><a href="#1-客户端如何确认服务端是没问题的（防服务端伪造）" class="headerlink" title="(1) 客户端如何确认服务端是没问题的（防服务端伪造）"></a>(1) 客户端如何确认服务端是没问题的（防服务端伪造）</h5><ol><li>服务端证书使用本地授信CA验签，说明这个证书是认证的。中间人的代理服务器的证书是不授信的，不过证书是公开的，中间人可能进行重放</li><li>预主密钥使用服务端证书的公钥加密，持有私钥的服务端才能解密，说明这个证书确实是服务端持有的。这里代理服务器就无法进行解密了，仅证书持有者才能解密</li></ol><h5 id="2-服务端如何确认客户端是没问题的（防客户端伪造）"><a href="#2-服务端如何确认客户端是没问题的（防客户端伪造）" class="headerlink" title="(2) 服务端如何确认客户端是没问题的（防客户端伪造）"></a>(2) 服务端如何确认客户端是没问题的（防客户端伪造）</h5><ol><li>客户端提交的证书服务端会使用本地授信的CA验签，说明证书是认证的。中间人的代理服务器的证书是不授信的，不过证书是公开的，中间人可能进行重放</li><li>客户端会使用证书私钥将握手数据的签名，服务端使用客户端证书的公钥验签通过，说明证书确实是服务端持有的。这里代理服务器就无法进行签名了，仅证书持有者才能签名</li></ol><h3 id="6-1-tls1-3的rsa证书双向认证"><a href="#6-1-tls1-3的rsa证书双向认证" class="headerlink" title="6.1. tls1.3的rsa证书双向认证"></a>6.1. tls1.3的rsa证书双向认证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端命令</span></span><br><span class="line">openssl s_server -accept 7777 -state -debug -key domain.key -cert domain.crt -CAfile cacert.pem -Verify 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端命令</span></span><br><span class="line">openssl s_client -connect 127.0.0.1:7777 -cipher RSA -tls1_3 -debug -keylogfile test.log -cert domain.crt -key domain.key</span><br></pre></td></tr></table></figure><p><img src="/2023-07-12-01.png"></p> <?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1791px" preserveAspectRatio="none" style="width:1492px;height:1791px;background:#fff" version="1.1" viewBox="0 0 1492 1791" width="1492px" zoomAndPan="magnify" class="kroki">$2<defs/><g><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="362" x2="362" y1="36.2969" y2="1756.25"/><line style="stroke:#181818;stroke-width:.5;stroke-dasharray:5,5" x1="1122" x2="1122" y1="36.2969" y2="1756.25"/><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="337" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="344" y="24.9951">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="51" x="337" y="1755.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="344" y="1775.2451">client</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="1094" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="1101" y="24.9951">server</text><rect fill="#E2E2F0" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:.5" width="57" x="1094" y="1755.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="1101" y="1775.2451">server</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1485" x="0" y="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1485" y1="66.8633" y2="66.8633"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1485" y1="69.8633" y2="69.8633"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="91" x="697" y="56.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="72" x="703" y="72.3638">ssl&#25569;&#25163;&#38454;&#27573;</text><polygon fill="#181818" points="1110.5,106.5625,1120.5,110.5625,1110.5,114.5625,1114.5,110.5625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="362.5" x2="1116.5" y1="110.5625" y2="110.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="369.5" y="105.4966">Client Hello</text><path d="M121,123.5625 L121,344.5625 L604,344.5625 L604,133.5625 L594,123.5625 L121,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M594,123.5625 L594,133.5625 L604,133.5625 L594,123.5625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="68" x="127" y="140.6294">client hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="127" y="155.7622">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="127" y="170.895">Handshake Type: Client Hello(1)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="454" x="135" y="186.0278">Version TLS 1.2 (0x0303) &#34429;&#28982;&#26159;tls1.2&#23454;&#38469;&#35201;&#30475;&#21518;&#38754;&#30340;supported_versions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="135" y="201.1606">&#31639;&#27861;&#22871;&#20214;&#20449;&#24687; Cipher Suites</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="377" x="151" y="216.2935">&#21253;&#21547;&#23494;&#38053;&#20132;&#25442;&#31639;&#27861;&#12289;&#36523;&#20221;&#35748;&#35777;&#31639;&#27861;&#12289;&#23545;&#31216;&#21152;&#23494;&#31639;&#27861;&#12289;&#20449;&#24687;&#25688;&#35201;&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="135" y="231.4263">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="151" y="246.5591">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="312" x="135" y="261.6919">tls&#25903;&#25345;&#30340;&#29256;&#26412; Extensions: supported_versions(43)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="135" y="276.8247">&#35831;&#27714;&#30340;&#26381;&#21153;&#21517; Extension: server_name(0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="339" x="135" y="291.9575">&#31614;&#21517;&#21704;&#24076;&#31639;&#27861;&#21015;&#34920; Extension: signature_algorithms(13)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="135" y="307.0903">&#23494;&#38053;&#20132;&#25442; Extension: key_share(51)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="151" y="322.2231">&#21457;&#36865;&#23458;&#25143;&#31471;&#20844;&#38053;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="349" x="135" y="337.356">&#23494;&#38053;&#20132;&#25442;&#27169;&#24335; Extension: psk_key_exchange_modes(45)</text><polygon fill="#181818" points="373.5,367.5547,363.5,371.5547,373.5,375.5547,369.5,371.5547" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="367.5" x2="1121.5" y1="371.5547" y2="371.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="736" x="379.5" y="366.4888">Server Hello, Change Cipher Spec, Encrypted Extensions, Certificate Request, Certificate, Certificate Verify, Finished</text><path d="M874,384.5547 L874,575.5547 L1370,575.5547 L1370,394.5547 L1360,384.5547 L874,384.5547 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1360,384.5547 L1360,394.5547 L1370,394.5547 L1360,384.5547 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="880" y="401.6216">Server Hello</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="880" y="416.7544">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="210" x="880" y="431.8872">Handshake Type: Server Hello(2)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="896" y="447.02">&#38543;&#26426;&#25968; Random</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242" x="912" y="462.1528">&#21069;&#22235;&#20010;&#23383;&#33410;&#20026;GMT Unix&#26102;&#38388;&#65292;&#22686;&#24378;&#38543;&#26426;&#24615;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="896" y="477.2856">&#20250;&#35805;id Session ID</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="912" y="492.4185">&#29992;&#20110;&#22797;&#29992;&#20250;&#35805;&#65292;&#23458;&#25143;&#31471;&#24102;&#20102;&#23601;&#22797;&#29992;&#65292;&#21542;&#21017;&#23601;&#26032;&#24314;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="896" y="507.5513">&#30830;&#23450;&#31639;&#27861;&#22871;&#20214; Cipher Suite</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="217" x="896" y="522.6841">&#23494;&#38053;&#20132;&#25442; Extension: key_share(51)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="912" y="537.8169">&#21457;&#36865;&#26381;&#21153;&#31471;&#20844;&#38053;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299" x="896" y="552.9497">tls&#25903;&#25345;&#29256;&#26412; Extensions: supported_versions(43)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="443" x="912" y="568.0825">&#22238;&#22797;&#23458;&#25143;&#31471;&#27492;&#23383;&#27573;&#65292;&#20195;&#34920;&#25903;&#25345;tls1.3&#29256;&#26412;&#24182;&#36873;&#25321;tls1.3&#65292;tls1.2&#19981;&#20250;&#22238;&#22797;&#27492;&#25299;&#23637;</text><path d="M987,586.1484 L987,641.1484 L1257,641.1484 L1257,596.1484 L1247,586.1484 L987,586.1484 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1247,586.1484 L1247,596.1484 L1257,596.1484 L1247,586.1484 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="993" y="603.2153">Change Cipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="249" x="993" y="618.3481">Content Type: Change Cipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="993" y="633.481">&#21578;&#30693;&#23458;&#25143;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M940,651.5469 L940,751.5469 L1304,751.5469 L1304,661.5469 L1294,651.5469 L940,651.5469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1294,651.5469 L1294,661.5469 L1304,661.5469 L1294,651.5469 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="946" y="668.6138">Encrypted Extensions</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="946" y="683.7466">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="946" y="698.8794">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="946" y="714.0122">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="946" y="729.145">Handshake Type: Encrypted Extension(8)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="343" x="946" y="744.2778">&#19968;&#33324;&#32473;&#30340;&#26159;&#19979;&#19968;&#23618;&#30340;&#21327;&#35758;&#31867;&#22411;&#65292;&#22914;ALPH Protocol: http/1.1</text><path d="M873,762.3438 L873,877.3438 L1371,877.3438 L1371,772.3438 L1361,762.3438 L873,762.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1361,762.3438 L1361,772.3438 L1371,772.3438 L1361,762.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="879" y="779.4106">Certificate Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="879" y="794.5435">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="879" y="809.6763">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="265" x="879" y="824.8091">Handshake Type: Certificate Request (13)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="359" x="895" y="839.9419">&#35201;&#27714;&#23458;&#25143;&#31471;&#25552;&#20132;&#35777;&#20070;&#65292;&#19968;&#33324;&#26159;nginx&#37197;&#32622;&#20013;&#24320;&#21551;&#20102;&#23545;&#31471;&#35777;&#20070;&#26657;&#39564;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="413" x="895" y="855.0747">Signature Hash Algorithms (23 algorithms) &#25903;&#25345;&#30340;&#31614;&#21517;&#21644;hash&#31639;&#27861;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="461" x="895" y="870.2075">Distinguished Names (135 bytes) CA&#30456;&#20851;&#20449;&#24687;&#65292;&#21482;&#25903;&#25345;&#27492;CA&#19979;&#21457;&#30340;&#30456;&#20851;&#35777;&#20070;</text><path d="M1000,888.2734 L1000,1019.2734 L1244,1019.2734 L1244,898.2734 L1234,888.2734 L1000,888.2734 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1234,888.2734 L1234,898.2734 L1244,898.2734 L1234,888.2734 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="1006" y="905.3403">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1006" y="920.4731">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="1006" y="935.606">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="1006" y="950.7388">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1006" y="965.8716">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="1006" y="981.0044">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="1006" y="996.1372">&#19979;&#21457;&#26381;&#21153;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="1006" y="1011.27">&#21253;&#21547;&#20027;&#39064;&#12289;&#20844;&#38053;&#12289;&#31614;&#21517;&#31639;&#27861;</text><path d="M764,1029.3359 L764,1129.3359 L1480,1129.3359 L1480,1039.3359 L1470,1029.3359 L764,1029.3359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1470,1029.3359 L1470,1039.3359 L1480,1039.3359 L1470,1029.3359 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="770" y="1046.4028">Certificate Verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="770" y="1061.5356">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="786" y="1076.6685">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="770" y="1091.8013">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="786" y="1106.9341">Handshake Type: Certificate Verify(15)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="663" x="802" y="1122.0669">&#26381;&#21153;&#31471;&#20351;&#29992;&#35777;&#20070;&#31169;&#38053;&#23545;&#35777;&#20070;&#21069;&#30340;&#25152;&#26377;&#25569;&#25163;&#25968;&#25454;&#25688;&#35201;&#21518;&#36827;&#34892;&#31614;&#21517;&#65292;&#35777;&#26126;&#35777;&#20070;&#26159;&#33258;&#24049;&#25345;&#26377;&#30340;&#65292;&#23458;&#25143;&#31471;&#20250;&#20351;&#29992;&#20844;&#38053;&#36827;&#34892;&#39564;&#35777;</text><path d="M1000,1140.1328 L1000,1240.1328 L1244,1240.1328 L1244,1150.1328 L1234,1140.1328 L1000,1140.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M1234,1140.1328 L1234,1150.1328 L1244,1150.1328 L1234,1140.1328 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="1006" y="1157.1997">Finished</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="1006" y="1172.3325">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="1006" y="1187.4653">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="1006" y="1202.5981">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1006" y="1217.731">Handshake Type: Finished(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="1006" y="1232.8638">server hello&#32467;&#26463;</text><polygon fill="#181818" points="1110.5,1263.0625,1120.5,1267.0625,1110.5,1271.0625,1114.5,1267.0625" style="stroke:#181818;stroke-width:1"/><line style="stroke:#181818;stroke-width:1" x1="362.5" x2="1116.5" y1="1267.0625" y2="1267.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="384" x="369.5" y="1261.9966">Change Chipher Spec, Certificate, Certificate Verify, Finished</text><path d="M223,1280.0625 L223,1335.0625 L501,1335.0625 L501,1290.0625 L491,1280.0625 L223,1280.0625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M491,1280.0625 L491,1290.0625 L501,1290.0625 L491,1280.0625 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="229" y="1297.1294">Change Chipher Spec</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="257" x="229" y="1312.2622">Content Type: Change Chipher Spec(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="195" x="229" y="1327.395">&#21578;&#30693;&#26381;&#21153;&#31471;&#65292;&#19979;&#38754;&#30340;&#25968;&#25454;&#35201;&#21152;&#23494;&#20102;</text><path d="M240,1345.4609 L240,1476.4609 L484,1476.4609 L484,1355.4609 L474,1345.4609 L240,1345.4609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M474,1345.4609 L474,1355.4609 L484,1355.4609 L474,1345.4609 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="246" y="1362.5278">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="246" y="1377.6606">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="246" y="1392.7935">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="246" y="1407.9263">Certificate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246" y="1423.0591">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="205" x="246" y="1438.1919">Handshake Type: Certificate(11)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="246" y="1453.3247">&#25552;&#20132;&#23458;&#25143;&#31471;&#35777;&#20070;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="246" y="1468.4575">&#21253;&#21547;&#20027;&#39064;&#12289;&#20844;&#38053;&#12289;&#31614;&#21517;&#31639;&#27861;</text><path d="M5,1486.5234 L5,1586.5234 L721,1586.5234 L721,1496.5234 L711,1486.5234 L5,1486.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M711,1486.5234 L711,1496.5234 L721,1496.5234 L711,1486.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="105" x="11" y="1503.5903">Certificate Verify</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="11" y="1518.7231">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="27" y="1533.856">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="11" y="1548.9888">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="27" y="1564.1216">Handshake Type: Certificate Verify(15)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="663" x="43" y="1579.2544">&#23458;&#25143;&#31471;&#20351;&#29992;&#35777;&#20070;&#31169;&#38053;&#23545;&#35777;&#20070;&#21069;&#30340;&#25152;&#26377;&#25569;&#25163;&#25968;&#25454;&#25688;&#35201;&#21518;&#36827;&#34892;&#31614;&#21517;&#65292;&#35777;&#26126;&#35777;&#20070;&#26159;&#33258;&#24049;&#25345;&#26377;&#30340;&#65292;&#26381;&#21153;&#31471;&#20250;&#20351;&#29992;&#20844;&#38053;&#36827;&#34892;&#39564;&#35777;</text><path d="M240,1597.3203 L240,1697.3203 L484,1697.3203 L484,1607.3203 L474,1597.3203 L240,1597.3203 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><path d="M474,1597.3203 L474,1607.3203 L484,1607.3203 L474,1597.3203 " fill="#FEFFDD" style="stroke:#181818;stroke-width:.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="246" y="1614.3872">Finished</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="246" y="1629.52">Opaque Type: Application Data(23)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="246" y="1644.6528">&#19979;&#38754;&#26159;&#35299;&#23494;&#21518;&#30340;&#25968;&#25454;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="246" y="1659.7856">Content Type: Handshake(22)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="246" y="1674.9185">Handshake Type: Finished(20)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="246" y="1690.0513">server hello&#32467;&#26463;</text><rect fill="#EEEEEE" height="3" style="stroke:#eee;stroke-width:1" width="1485" x="0" y="1723.6836"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1485" y1="1723.6836" y2="1723.6836"/><line style="stroke:#000;stroke-width:1" x1="0" x2="1485" y1="1726.6836" y2="1726.6836"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000;stroke-width:2" width="117" x="684" y="1713.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="98" x="690" y="1729.1841">&#24320;&#22987;ssl&#25968;&#25454;&#20256;&#36755;</text></g></svg><h1 id="五、国密相关"><a href="#五、国密相关" class="headerlink" title="五、国密相关"></a>五、国密相关</h1><h2 id="1-知识扫盲"><a href="#1-知识扫盲" class="headerlink" title="1. 知识扫盲"></a>1. 知识扫盲</h2><h3 id="1-1-算法"><a href="#1-1-算法" class="headerlink" title="1.1. 算法"></a>1.1. 算法</h3><ul><li>sm1: 对称加密算法，本身闭源，需要使用ukey硬件中的接口实现</li><li>sm2: 非对称加密算法，本身基于ecc椭圆算法实现，可以使用软件进行实现</li><li>sm3: 摘要算法</li><li>sm4: 对称加密算法，可以使用软件实现</li></ul><h3 id="1-2-算法套件"><a href="#1-2-算法套件" class="headerlink" title="1.2. 算法套件"></a>1.2. 算法套件</h3><h4 id="ECC-SM4-SM3"><a href="#ECC-SM4-SM3" class="headerlink" title="ECC-SM4-SM3"></a>ECC-SM4-SM3</h4><p>算法可以类比<code>TLS_RSA_WITH_AES_256_GCM_SHA384</code>，其中</p><ul><li>ECC对应RSA，密钥交换算法，由客户端生成预主密钥，使用ECC椭圆算法用服务端公钥加密</li><li>SM4对应<code>AES_256_GCM</code>，对称加密算法，为握手完成后的数据传输阶段的算法</li><li>SM3对应<code>SHA384</code>，摘要算法</li></ul><h4 id="ECC-SM1-SM3"><a href="#ECC-SM1-SM3" class="headerlink" title="ECC-SM1-SM3"></a>ECC-SM1-SM3</h4><p>仅将SM4换成SM1的闭源实现，其他都一样</p><h1 id="六、工程开发"><a href="#六、工程开发" class="headerlink" title="六、工程开发"></a>六、工程开发</h1><h2 id="1-cmake"><a href="#1-cmake" class="headerlink" title="1. cmake"></a>1. cmake</h2><h3 id="1-1-引入cmake使用"><a href="#1-1-引入cmake使用" class="headerlink" title="1.1. 引入cmake使用"></a>1.1. 引入cmake使用</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置find之后，下面几个变量会进行赋值，引入到library和include里面即可</span></span><br><span class="line"><span class="keyword">find_package</span>(OpenSSL REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;$&#123;OPENSSL_INCLUDE_DIR&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;$&#123;OPENSSL_SSL_LIBRARY&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;$&#123;OPENSSL_CRYPTO_LIBRARY&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(<span class="string">&quot;$&#123;OPENSSL_LIBRARIES&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="1-2-系统安装了多个openssl版本，如何指定版本"><a href="#1-2-系统安装了多个openssl版本，如何指定版本" class="headerlink" title="1.2. 系统安装了多个openssl版本，如何指定版本"></a>1.2. 系统安装了多个openssl版本，如何指定版本</h3><ul><li>在cmakecache里面指定一下下面几个值，重新生成一下就好了</li></ul><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OPENSSL_CRYPTO_LIBRARY:FILEPATH=/usr/lib/openssl-<span class="number">1.1</span>/libcrypto.so</span><br><span class="line"></span><br><span class="line">//Path to a <span class="keyword">file</span>.</span><br><span class="line">OPENSSL_INCLUDE_DIR:PATH=/usr/<span class="keyword">include</span>/openssl-<span class="number">1.1</span></span><br><span class="line"></span><br><span class="line">OPENSSL_LIBRARIES:UNINITIALIZED=/usr/lib/openssl-<span class="number">1.1</span>/libssl.so;/usr/lib/openssl-<span class="number">1.1</span>/libcrypto.so</span><br><span class="line"></span><br><span class="line">//Path to a library.</span><br><span class="line">OPENSSL_SSL_LIBRARY:FILEPATH=/usr/lib/openssl-<span class="number">1.1</span>/libssl.so</span><br></pre></td></tr></table></figure><h2 id="2-编译-1"><a href="#2-编译-1" class="headerlink" title="2. 编译"></a>2. 编译</h2><h1 id="小技巧和踩坑记"><a href="#小技巧和踩坑记" class="headerlink" title="小技巧和踩坑记"></a>小技巧和踩坑记</h1><h2 id="1-使用openssl命令模拟https请求"><a href="#1-使用openssl命令模拟https请求" class="headerlink" title="1. 使用openssl命令模拟https请求"></a>1. 使用openssl命令模拟https请求</h2><ul><li>https就是在ssl握手的基础上，发送http请求</li><li>http请求的原生格式如下</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /xxx/aaa/ddd HTTP/1.1</span><br><span class="line">Host: 172.22.230.48</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 125</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&quot;appName&quot;:&quot;test&quot;,&quot;containerName&quot;: &quot;1&quot;,&quot;model&quot;:&quot;aa&quot;,&quot;certSN&quot;:&quot;12345&quot;,&quot;path&quot;:&quot;c:\\asdf&quot;,&quot;username&quot;:&quot;asdf&quot;,&quot;issuer&quot;:&quot;asdf&quot;&#125;</span><br></pre></td></tr></table></figure><ul><li>当openssl连接上服务端的端口后，将上述文本复制到命令行，回车即可发送请求</li><li>注: content-length是要求和正文内容长度一致，需要注意换行所占字节数</li></ul><h2 id="2-让浏览器信任自己颁发的证书"><a href="#2-让浏览器信任自己颁发的证书" class="headerlink" title="2. 让浏览器信任自己颁发的证书"></a>2. 让浏览器信任自己颁发的证书</h2><h3 id="1-windows"><a href="#1-windows" class="headerlink" title="1) windows"></a>1) windows</h3><ul><li>只需要将CA导入到ie的受信任的根证书颁发机构就好了</li></ul><h3 id="2-linux"><a href="#2-linux" class="headerlink" title="2) linux"></a>2) linux</h3><h4 id="archlinux"><a href="#archlinux" class="headerlink" title="archlinux"></a>archlinux</h4><p><a href="/blogs/2021-04-02-archlinux/#4-%E4%BF%A1%E4%BB%BBCA%E8%AF%81%E4%B9%A6">信任CA证书</a></p><h4 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h4><p><a href="/blogs/2018-07-27-ubuntuStudy/#2-%E4%BF%A1%E4%BB%BBCA%E8%AF%81%E4%B9%A6">信任CA证书</a></p><h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><h4 id="1-自己颁发的证书，chrome导入了ca还是不授信"><a href="#1-自己颁发的证书，chrome导入了ca还是不授信" class="headerlink" title="(1) 自己颁发的证书，chrome导入了ca还是不授信"></a>(1) <font color="red">自己颁发的证书，chrome导入了ca还是不授信</font></h4><ul><li>新版chrome加了一个安全选项，需要存在SAN（Subject Alternative Name）字段才可以授信</li><li>操作具体见 <a href="#3-%E7%94%9F%E6%88%90%E5%B8%A6%E6%8B%93%E5%B1%95%E5%AD%97%E6%AE%B5%E7%9A%84%E8%AF%81%E4%B9%A6">生成带拓展字段的证书</a></li><li>格式类似下面</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            ...</span><br><span class="line">            X509v3 Subject Alternative Name:</span><br><span class="line">                DNS:www.abcdtest.com</span><br><span class="line">...</span><br></pre></td></tr></table></figure><ul><li>DNS字段需要和访问的域名对应才行</li></ul></div><div class="reward-container"><div></div><button onclick='var qr=document.getElementById("qr");qr.style.display="none"===qr.style.display?"block":"none"'>打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/wechatpay.png" alt="王钰博 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/alipay.jpg" alt="王钰博 支付宝"><p>支付宝</p></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag"># 网络</a></div><div class="post-nav"><div class="post-nav-item"><a href="/blogs/2021-04-23-nginx/" rel="prev" title="nginx配置和源码分析"><i class="fa fa-chevron-left"></i> nginx配置和源码分析</a></div><div class="post-nav-item"><a href="/blogs/2021-09-23-web-offense-and-defense/" rel="next" title="web攻防相关知识">web攻防相关知识 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener("tabs:register",()=>{let{activeClass:t}=CONFIG.comments;if(CONFIG.comments.storage&&(t=localStorage.getItem("comments_active")||t),t){let e=document.querySelector(`a[href="#comment-${t}"]`);e&&e.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{if(!t.target.matches(".tabs-comment .tab-content .tab-pane"))return;let e=t.target.classList[1];localStorage.setItem("comments_active",e)})</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="nav-text">一、前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD"><span class="nav-text">1. 下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%BC%96%E8%AF%91"><span class="nav-text">2. 编译</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%BC%96%E8%AF%91"><span class="nav-text">2.1. 二进制编译</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-linux"><span class="nav-text">1) linux</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%BC%95%E6%93%8E%E7%BC%96%E8%AF%91"><span class="nav-text">2.2. 引擎编译</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%91%BD%E4%BB%A4"><span class="nav-text">二、命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-text">1. 一些基本用法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%9B%BD%E5%AF%86openssl%E5%91%BD%E4%BB%A4"><span class="nav-text">1.1. 国密openssl命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%AF%81%E4%B9%A6"><span class="nav-text">2. 证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E9%A2%81%E5%8F%91%E8%AF%81%E4%B9%A6"><span class="nav-text">1.1. 颁发证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%9B%BD%E9%99%85%E5%AF%86%E7%A0%81%E6%A0%87%E5%87%86%EF%BC%88%E6%99%AE%E5%AF%86%EF%BC%89"><span class="nav-text">(1) 国际密码标准（普密）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%B8%AD%E5%9B%BD%E5%AF%86%E7%A0%81%E6%A0%87%E5%87%86%EF%BC%88%E5%9B%BD%E5%AF%86%EF%BC%89"><span class="nav-text">(2) 中国密码标准（国密）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E7%94%9F%E6%88%90%E5%B8%A6%E6%8B%93%E5%B1%95%E5%AD%97%E6%AE%B5%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="nav-text">(3) 生成带拓展字段的证书</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E8%AF%81%E4%B9%A6%E8%BD%AC%E6%8D%A2"><span class="nav-text">1.2. 证书转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E9%AA%8C%E8%AF%81%E8%AF%81%E4%B9%A6"><span class="nav-text">1.3. 验证证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E6%9F%A5%E7%9C%8B%E8%AF%81%E4%B9%A6"><span class="nav-text">1.4. 查看证书</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%AE%A2%E6%88%B7%E7%AB%AF-openssl-s-client"><span class="nav-text">3. 客户端 openssl s_client</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E9%80%89%E9%A1%B9"><span class="nav-text">3.1. 选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E7%A4%BA%E4%BE%8B%E7%94%A8%E6%B3%95"><span class="nav-text">3.2. 示例用法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%9C%8D%E5%8A%A1%E7%AB%AF-openssl-s-server"><span class="nav-text">4. 服务端 openssl s_server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E7%A4%BA%E4%BE%8B%E7%94%A8%E6%B3%95"><span class="nav-text">4.2. 示例用法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81openssl%E5%BA%93"><span class="nav-text">三、openssl库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%95%E6%93%8E%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97"><span class="nav-text">1. 引擎开发指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E7%AE%80%E4%BB%8B"><span class="nav-text">1.1. 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%9F%BA%E7%A1%80%E6%8E%A5%E5%8F%A3"><span class="nav-text">1.2. 基础接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E7%BC%96%E8%AF%91"><span class="nav-text">1.3. 编译</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#makefile"><span class="nav-text">makefile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cmake"><span class="nav-text">cmake</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%8A%A0%E8%BD%BD%E5%BC%95%E6%93%8E"><span class="nav-text">1.4. 加载引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E6%B5%8B%E8%AF%95%E5%91%BD%E4%BB%A4"><span class="nav-text">1.5. 测试命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-%E4%BD%BF%E7%94%A8skf%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0rsa%E5%BC%95%E6%93%8E"><span class="nav-text">1.6. 使用skf接口实现rsa引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84skf%E5%BC%95%E6%93%8E%E7%9A%84%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0"><span class="nav-text">1) 需要用到的skf引擎的关键函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-skf%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E5%88%B0openssl%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0"><span class="nav-text">2) skf导出数据到openssl结构体的工具函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-openssl%E4%B8%AD%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%87%BD%E6%95%B0%E5%92%8C%E7%BB%93%E6%9E%84%E4%BD%93%E8%AE%B2%E8%A7%A3"><span class="nav-text">3) openssl中需要用到的一些函数和结构体讲解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E7%BB%93%E5%90%88skf%E5%92%8Copenssl%E7%9A%84%E5%8E%9F%E7%90%86%E8%AE%B2%E8%A7%A3%E4%B8%80%E4%B8%8B"><span class="nav-text">4) 结合skf和openssl的原理讲解一下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E5%BC%95%E6%93%8E%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%A0%81"><span class="nav-text">5) 引擎设置代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-%E4%BD%BF%E7%94%A8skf%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0sm2%E5%9B%BD%E5%AF%86%E5%BC%95%E6%93%8E"><span class="nav-text">1.7. 使用skf接口实现sm2国密引擎</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%9A%8F%E6%9C%BA%E6%95%B0%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95"><span class="nav-text">2. 随机数生成算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF%E8%BE%93%E5%87%BA"><span class="nav-text">3. 错误信息输出</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-rsa%E7%AD%BE%E5%90%8D%E4%B8%8E%E6%A0%A1%E9%AA%8C"><span class="nav-text">4. rsa签名与校验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%8E%A5%E5%8F%A3%E5%92%8C%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text">4.1. 接口和结构体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-RSA-sign%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-text">4.2. RSA_sign源码解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-RSA-verify%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-text">4.3. RSA_verify源码解析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%8F%A1%E6%89%8B%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">四、握手流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">1. 前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-ssl%E6%8F%A1%E6%89%8B%E7%9A%84%E5%87%A0%E4%B8%AA%E5%85%B3%E9%94%AE%E7%82%B9"><span class="nav-text">1.1. ssl握手的几个关键点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-rsa%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2"><span class="nav-text">1.2. rsa密钥交换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-ECC%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2"><span class="nav-text">1.3. ECC密钥交换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-ECDH%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2"><span class="nav-text">1.4. ECDH密钥交换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E5%8F%8C%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB"><span class="nav-text">1.5. 双证书体系</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AE%A2%E6%88%B7%E7%AB%AFukey"><span class="nav-text">1) 客户端ukey</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%87%8D%E5%8D%8F%E5%95%86%E6%B5%81%E7%A8%8B"><span class="nav-text">2. 重协商流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-tls1-2-rsa%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B-Cipher-Suite-TLS-RSA-WITH-AES-256-GCM-SHA384-0x009d"><span class="nav-text">3. tls1.2 rsa密钥交换握手过程 Cipher Suite: TLS_RSA_WITH_AES_256_GCM_SHA384 (0x009d)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-TLS1-2-ecdhe%E6%8F%A1%E6%89%8B%E6%B5%81%E7%A8%8B-Cipher-Suite-TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384-0xc030"><span class="nav-text">4. TLS1.2 ecdhe握手流程 Cipher Suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xc030)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-TLS1-3-%E6%8F%A1%E6%89%8B%E6%B5%81%E7%A8%8B-TLS-AES-256-GCM-SHA384-0x1302"><span class="nav-text">5. TLS1.3 握手流程 TLS_AES_256_GCM_SHA384(0x1302)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B%E8%A7%A3%E9%87%8A"><span class="nav-text">5.1. 握手过程解释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-psk-key-exchange-modes"><span class="nav-text">5.2. psk_key_exchange_modes</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B"><span class="nav-text">6. 双向认证流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-tls1-2%E7%9A%84rsa%E8%AF%81%E4%B9%A6%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81"><span class="nav-text">6.1. tls1.2的rsa证书双向认证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%98%B2%E4%B8%AD%E9%97%B4%E4%BA%BA%E5%A4%84%E7%90%86"><span class="nav-text">1) 防中间人处理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E7%A1%AE%E8%AE%A4%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%98%AF%E6%B2%A1%E9%97%AE%E9%A2%98%E7%9A%84%EF%BC%88%E9%98%B2%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BC%AA%E9%80%A0%EF%BC%89"><span class="nav-text">(1) 客户端如何确认服务端是没问题的（防服务端伪造）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A6%82%E4%BD%95%E7%A1%AE%E8%AE%A4%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%98%AF%E6%B2%A1%E9%97%AE%E9%A2%98%E7%9A%84%EF%BC%88%E9%98%B2%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BC%AA%E9%80%A0%EF%BC%89"><span class="nav-text">(2) 服务端如何确认客户端是没问题的（防客户端伪造）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-tls1-3%E7%9A%84rsa%E8%AF%81%E4%B9%A6%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81"><span class="nav-text">6.1. tls1.3的rsa证书双向认证</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%9B%BD%E5%AF%86%E7%9B%B8%E5%85%B3"><span class="nav-text">五、国密相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%9F%A5%E8%AF%86%E6%89%AB%E7%9B%B2"><span class="nav-text">1. 知识扫盲</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E7%AE%97%E6%B3%95"><span class="nav-text">1.1. 算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%AE%97%E6%B3%95%E5%A5%97%E4%BB%B6"><span class="nav-text">1.2. 算法套件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ECC-SM4-SM3"><span class="nav-text">ECC-SM4-SM3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ECC-SM1-SM3"><span class="nav-text">ECC-SM1-SM3</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%B7%A5%E7%A8%8B%E5%BC%80%E5%8F%91"><span class="nav-text">六、工程开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-cmake"><span class="nav-text">1. cmake</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%BC%95%E5%85%A5cmake%E4%BD%BF%E7%94%A8"><span class="nav-text">1.1. 引入cmake使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E4%BA%86%E5%A4%9A%E4%B8%AAopenssl%E7%89%88%E6%9C%AC%EF%BC%8C%E5%A6%82%E4%BD%95%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC"><span class="nav-text">1.2. 系统安装了多个openssl版本，如何指定版本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%BC%96%E8%AF%91-1"><span class="nav-text">2. 编译</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7%E5%92%8C%E8%B8%A9%E5%9D%91%E8%AE%B0"><span class="nav-text">小技巧和踩坑记</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8openssl%E5%91%BD%E4%BB%A4%E6%A8%A1%E6%8B%9Fhttps%E8%AF%B7%E6%B1%82"><span class="nav-text">1. 使用openssl命令模拟https请求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%AE%A9%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BF%A1%E4%BB%BB%E8%87%AA%E5%B7%B1%E9%A2%81%E5%8F%91%E7%9A%84%E8%AF%81%E4%B9%A6"><span class="nav-text">2. 让浏览器信任自己颁发的证书</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-windows"><span class="nav-text">1) windows</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-linux"><span class="nav-text">2) linux</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#archlinux"><span class="nav-text">archlinux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ubuntu"><span class="nav-text">ubuntu</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98"><span class="nav-text">其他问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%87%AA%E5%B7%B1%E9%A2%81%E5%8F%91%E7%9A%84%E8%AF%81%E4%B9%A6%EF%BC%8Cchrome%E5%AF%BC%E5%85%A5%E4%BA%86ca%E8%BF%98%E6%98%AF%E4%B8%8D%E6%8E%88%E4%BF%A1"><span class="nav-text">(1) 自己颁发的证书，chrome导入了ca还是不授信</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="王钰博" src="/images/12.jpg"><p class="site-author-name" itemprop="name">王钰博</p><div class="site-description" itemprop="description">个人博客</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">122</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Githubwyb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Githubwyb" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:1061322005@qq.com" title="E-Mail → mailto:1061322005@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div><div class="links-of-blogroll motion-element"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://githubwyb.github.io/bookPages/" title="https:&#x2F;&#x2F;githubwyb.github.io&#x2F;bookPages&#x2F;">markdown books</a></li></ul></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">豫ICP备16023189号 </a><img src="/images/beian.png" style="display:inline-block"></div><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">王钰博</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="站点总字数">941k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">14:16</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e1986d4e4e2d132" async></script></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/medium-zoom.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/js/local-search.js"></script><script>document.querySelectorAll(".pdfobject-container").forEach(e=>{let t=e.dataset.target,a="#"+Object.entries({navpanes:0,toolbar:0,statusbar:0,pagemode:"thumbs",view:"FitH"}).map(([e,t])=>`${e}=${encodeURIComponent(t)}`).join("&"),i=`/lib/pdf/web/viewer.html?file=${encodeURIComponent(t)}${a}`;NexT.utils.supportsPDFs()?e.innerHTML=`<embed class="pdfobject" src="${t+a}" type="application/pdf" style="height: ${e.dataset.height};">`:e.innerHTML=`<iframe src="${i}" style="height: ${e.dataset.height};" frameborder="0"></iframe>`})</script><script>"undefined"==typeof MathJax?(window.MathJax={loader:{source:{"[tex]/amsCd":"[tex]/amscd","[tex]/AMScd":"[tex]/amscd"}},tex:{inlineMath:{"[+]":[["$","$"]]},tags:"ams"},options:{renderActions:{findScript:[10,e=>{document.querySelectorAll('script[type^="math/tex"]').forEach(t=>{const a=!!t.type.match(/; *mode=display/),n=new e.options.MathItem(t.textContent,e.inputJax[0],a),d=document.createTextNode("");t.parentNode.replaceChild(d,t),n.start={node:d,delim:"",n:0},n.end={node:d,delim:"",n:0},e.math.push(n)})},"",!1],insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(e=>{let t=e.parentNode;"li"===t.nodeName.toLowerCase()&&t.parentNode.classList.add("has-jax")})},"",!1]}}},function(){var e=document.createElement("script");e.src="/lib/mathjax/tex-mml-chtml.js",e.defer=!0,document.head.appendChild(e)}()):(MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset())</script><script>NexT.utils.loadComments(document.querySelector("#valine-comments"),()=>{NexT.utils.getScript("//unpkg.com/valine/dist/Valine.min.js",()=>{var e=["nick","mail","link"],a="nick,mail";a=a.split(",").filter(a=>e.includes(a)),new Valine({el:"#valine-comments",verify:!1,notify:!1,appId:"qmLbUHV1HOr841BOYkl84riu-gzGzoHsz",appKey:"j4fgTcf1yHRDD5X3HUH5EH95",placeholder:"^_^ happy everyday!",avatar:"wavatar",meta:a,pageSize:"10",visitor:!1,lang:"zh-cn",path:location.pathname,recordIP:!1,serverURLs:""})},window.Valine)})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":true,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"bottom":-30,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body><script type="text/javascript" src="/lib/jquery-3.4.1.min.js"></script><script type="text/javascript" src="/js/src/love.js"></script></html>