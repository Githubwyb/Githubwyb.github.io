THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0;this.renderOrder=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.z=0;this.renderOrder=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld);this.positionScreen.copy(e.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0;this.renderOrder=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2;this.material=null;this.renderOrder=0};THREE.Projector=function(){var Z,$,r=[],t=0,s,_,ee=[],n=0,re,te,i=[],o=0,ne,ie,a=[],l=0,oe,ae,c=[],u=0,se={objects:[],lights:[],elements:[]},le=new THREE.Vector3,ce=new THREE.Vector4,m=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),R=new THREE.Box3,h=new Array(3),e=new Array(4),ue=new THREE.Matrix4,pe=new THREE.Matrix4,fe,Ee=new THREE.Matrix4,ve=new THREE.Matrix3,de=new THREE.Frustum,he=new THREE.Vector4,me=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project().");e.project(r)};this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");e.unproject(r)};this.pickingRay=function(e,r){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var p=function(){var c=[];var u=[];var p=null;var f=null;var E=new THREE.Matrix3;function e(e){p=e;f=p.material;E.getNormalMatrix(p.matrixWorld);c.length=0;u.length=0}function n(e){var r=e.position;var t=e.positionWorld;var n=e.positionScreen;t.copy(r).applyMatrix4(fe);n.copy(t).applyMatrix4(pe);var i=1/n.w;n.x*=i;n.y*=i;n.z*=i;e.visible=n.x>=-1&&n.x<=1&&n.y>=-1&&n.y<=1&&n.z>=-1&&n.z<=1}function r(e,r,t){s=xe();s.position.set(e,r,t);n(s)}function t(e,r,t){c.push(e,r,t)}function i(e,r){u.push(e,r)}function v(e,r,t){if(e.visible===true||r.visible===true||t.visible===true)return true;h[0]=e.positionScreen;h[1]=r.positionScreen;h[2]=t.positionScreen;return m.intersectsBox(R.setFromPoints(h))}function d(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}function o(e,r){var t=ee[e];var n=ee[r];ne=Te();ne.id=p.id;ne.v1.copy(t);ne.v2.copy(n);ne.z=(t.positionScreen.z+n.positionScreen.z)/2;ne.renderOrder=p.renderOrder;ne.material=p.material;se.elements.push(ne)}function a(e,r,t){var n=ee[e];var i=ee[r];var o=ee[t];if(v(n,i,o)===false)return;if(f.side===THREE.DoubleSide||d(n,i,o)===true){re=ye();re.id=p.id;re.v1.copy(n);re.v2.copy(i);re.v3.copy(o);re.z=(n.positionScreen.z+i.positionScreen.z+o.positionScreen.z)/3;re.renderOrder=p.renderOrder;re.normalModel.fromArray(c,e*3);re.normalModel.applyMatrix3(E).normalize();for(var a=0;a<3;a++){var s=re.vertexNormalsModel[a];s.fromArray(c,arguments[a]*3);s.applyMatrix3(E).normalize();var l=re.uvs[a];l.fromArray(u,arguments[a]*2)}re.vertexNormalsLength=3;re.material=p.material;se.elements.push(re)}}return{setObject:e,projectVertex:n,checkTriangleVisibility:v,checkBackfaceCulling:d,pushVertex:r,pushNormal:t,pushUv:i,pushLine:o,pushTriangle:a}};var Re=new p;this.projectScene=function(e,r,W,B){te=0;ie=0;ae=0;se.elements.length=0;if(e.autoUpdate===true)e.updateMatrixWorld();if(r.parent===null)r.updateMatrixWorld();ue.copy(r.matrixWorldInverse.getInverse(r.matrixWorld));pe.multiplyMatrices(r.projectionMatrix,ue);de.setFromMatrix(pe);$=0;se.objects.length=0;se.lights.length=0;function t(e){Z=He();Z.id=e.id;Z.object=e;le.setFromMatrixPosition(e.matrixWorld);le.applyMatrix4(pe);Z.z=le.z;Z.renderOrder=e.renderOrder;se.objects.push(Z)}e.traverseVisible(function(e){if(e instanceof THREE.Light){se.lights.push(e)}else if(e instanceof THREE.Mesh||e instanceof THREE.Line){if(e.material.visible===false)return;if(e.frustumCulled===true&&de.intersectsObject(e)===false)return;t(e)}else if(e instanceof THREE.Sprite){if(e.material.visible===false)return;if(e.frustumCulled===true&&de.intersectsSprite(e)===false)return;t(e)}});if(W===true){se.objects.sort(ge)}for(var n=0,F=se.objects.length;n<F;n++){var i=se.objects[n].object;var o=i.geometry;Re.setObject(i);fe=i.matrixWorld;_=0;if(i instanceof THREE.Mesh){if(o instanceof THREE.BufferGeometry){var a=o.attributes;var s=o.groups;if(a.position===undefined)continue;var l=a.position.array;for(var c=0,u=l.length;c<u;c+=3){Re.pushVertex(l[c],l[c+1],l[c+2])}if(a.normal!==undefined){var p=a.normal.array;for(var c=0,u=p.length;c<u;c+=3){Re.pushNormal(p[c],p[c+1],p[c+2])}}if(a.uv!==undefined){var f=a.uv.array;for(var c=0,u=f.length;c<u;c+=2){Re.pushUv(f[c],f[c+1])}}if(o.index!==null){var E=o.index.array;if(s.length>0){for(var v=0;v<s.length;v++){var d=s[v];for(var c=d.start,u=d.start+d.count;c<u;c+=3){Re.pushTriangle(E[c],E[c+1],E[c+2])}}}else{for(var c=0,u=E.length;c<u;c+=3){Re.pushTriangle(E[c],E[c+1],E[c+2])}}}else{for(var c=0,u=l.length/3;c<u;c+=3){Re.pushTriangle(c,c+1,c+2)}}}else if(o instanceof THREE.Geometry){var h=o.vertices;var m=o.faces;var P=o.faceVertexUvs[0];ve.getNormalMatrix(fe);var R=i.material;var A=R instanceof THREE.MultiMaterial;var D=A===true?i.material:null;for(var x=0,G=h.length;x<G;x++){var y=h[x];le.copy(y);if(R.morphTargets===true){var I=o.morphTargets;var U=i.morphTargetInfluences;for(var T=0,q=I.length;T<q;T++){var H=U[T];if(H===0)continue;var J=I[T];var w=J.vertices[x];le.x+=(w.x-y.x)*H;le.y+=(w.y-y.y)*H;le.z+=(w.z-y.z)*H}}Re.pushVertex(le.x,le.y,le.z)}for(var g=0,K=m.length;g<K;g++){var b=m[g];R=A===true?D.materials[b.materialIndex]:i.material;if(R===undefined)continue;var M=R.side;var S=ee[b.a];var z=ee[b.b];var V=ee[b.c];if(Re.checkTriangleVisibility(S,z,V)===false)continue;var j=Re.checkBackfaceCulling(S,z,V);if(M!==THREE.DoubleSide){if(M===THREE.FrontSide&&j===false)continue;if(M===THREE.BackSide&&j===true)continue}re=ye();re.id=i.id;re.v1.copy(S);re.v2.copy(z);re.v3.copy(V);re.normalModel.copy(b.normal);if(j===false&&(M===THREE.BackSide||M===THREE.DoubleSide)){re.normalModel.negate()}re.normalModel.applyMatrix3(ve).normalize();var O=b.vertexNormals;for(var C=0,Q=Math.min(O.length,3);C<Q;C++){var L=re.vertexNormalsModel[C];L.copy(O[C]);if(j===false&&(M===THREE.BackSide||M===THREE.DoubleSide)){L.negate()}L.applyMatrix3(ve).normalize()}re.vertexNormalsLength=O.length;var X=P[g];if(X!==undefined){for(var k=0;k<3;k++){re.uvs[k].copy(X[k])}}re.color=b.color;re.material=R;re.z=(S.positionScreen.z+z.positionScreen.z+V.positionScreen.z)/3;re.renderOrder=i.renderOrder;se.elements.push(re)}}}else if(i instanceof THREE.Line){if(o instanceof THREE.BufferGeometry){var a=o.attributes;if(a.position!==undefined){var l=a.position.array;for(var c=0,u=l.length;c<u;c+=3){Re.pushVertex(l[c],l[c+1],l[c+2])}if(o.index!==null){var E=o.index.array;for(var c=0,u=E.length;c<u;c+=2){Re.pushLine(E[c],E[c+1])}}else{var Y=i instanceof THREE.LineSegments?2:1;for(var c=0,u=l.length/3-1;c<u;c+=Y){Re.pushLine(c,c+1)}}}}else if(o instanceof THREE.Geometry){Ee.multiplyMatrices(pe,fe);var h=i.geometry.vertices;if(h.length===0)continue;S=xe();S.positionScreen.copy(h[0]).applyMatrix4(Ee);var Y=i instanceof THREE.LineSegments?2:1;for(var x=1,G=h.length;x<G;x++){S=xe();S.positionScreen.copy(h[x]).applyMatrix4(Ee);if((x+1)%Y>0)continue;z=ee[_-2];he.copy(S.positionScreen);me.copy(z.positionScreen);if(be(he,me)===true){he.multiplyScalar(1/he.w);me.multiplyScalar(1/me.w);ne=Te();ne.id=i.id;ne.v1.positionScreen.copy(he);ne.v2.positionScreen.copy(me);ne.z=Math.max(he.z,me.z);ne.renderOrder=i.renderOrder;ne.material=i.material;if(i.material.vertexColors===THREE.VertexColors){ne.vertexColors[0].copy(i.geometry.colors[x]);ne.vertexColors[1].copy(i.geometry.colors[x-1])}se.elements.push(ne)}}}}else if(i instanceof THREE.Sprite){ce.set(fe.elements[12],fe.elements[13],fe.elements[14],1);ce.applyMatrix4(pe);var N=1/ce.w;ce.z*=N;if(ce.z>=-1&&ce.z<=1){oe=we();oe.id=i.id;oe.x=ce.x*N;oe.y=ce.y*N;oe.z=ce.z;oe.renderOrder=i.renderOrder;oe.object=i;oe.rotation=i.rotation;oe.scale.x=i.scale.x*Math.abs(oe.x-(ce.x+r.projectionMatrix.elements[0])/(ce.w+r.projectionMatrix.elements[12]));oe.scale.y=i.scale.y*Math.abs(oe.y-(ce.y+r.projectionMatrix.elements[5])/(ce.w+r.projectionMatrix.elements[13]));oe.material=i.material;se.elements.push(oe)}}}if(B===true){se.elements.sort(ge)}return se};function He(){if($===t){var e=new THREE.RenderableObject;r.push(e);t++;$++;return e}return r[$++]}function xe(){if(_===n){var e=new THREE.RenderableVertex;ee.push(e);n++;_++;return e}return ee[_++]}function ye(){if(te===o){var e=new THREE.RenderableFace;i.push(e);o++;te++;return e}return i[te++]}function Te(){if(ie===l){var e=new THREE.RenderableLine;a.push(e);l++;ie++;return e}return a[ie++]}function we(){if(ae===u){var e=new THREE.RenderableSprite;c.push(e);u++;ae++;return e}return c[ae++]}function ge(e,r){if(e.renderOrder!==r.renderOrder){return e.renderOrder-r.renderOrder}else if(e.z!==r.z){return r.z-e.z}else if(e.id!==r.id){return e.id-r.id}else{return 0}}function be(e,r){var t=0,n=1,i=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;if(i>=0&&o>=0&&a>=0&&s>=0){return true}else if(i<0&&o<0||a<0&&s<0){return false}else{if(i<0){t=Math.max(t,i/(i-o))}else if(o<0){n=Math.min(n,i/(i-o))}if(a<0){t=Math.max(t,a/(a-s))}else if(s<0){n=Math.min(n,a/(a-s))}if(n<t){return false}else{e.lerp(r,t);r.lerp(e,1-n);return true}}}};