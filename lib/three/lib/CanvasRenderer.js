THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this);this.type="SpriteCanvasMaterial";this.color=new THREE.Color(16777215);this.program=function(e,i){};this.setValues(e)};THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype);THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial;THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;e.copy(this);e.color.copy(this.color);e.program=this.program;return e};THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION);e=e||{};var c=this,s,F,l,I=new THREE.Projector,n=e.canvas!==undefined?e.canvas:document.createElement("canvas"),f=n.width,p=n.height,h=Math.floor(f/2),m=Math.floor(p/2),N=0,O=0,A=f,G=p,r=1,C=n.getContext("2d",{alpha:e.alpha===true}),t=new THREE.Color(0),o=e.alpha===true?0:1,a=1,U=0,q=null,J=null,K=null,Q=null,X=null,i=[],Y,E,d,u,Z,$=new THREE.RenderableVertex,_=new THREE.RenderableVertex,v,x,y,R,g,T,ee,ie,te,ne,re,oe,S=new THREE.Color,ae=new THREE.Color,se=new THREE.Color,le=new THREE.Color,ce=new THREE.Color,fe=new THREE.Color,pe=new THREE.Color,Ee=new THREE.Color,M={},de,w,ue,he,me,ve,xe,ye,H=new THREE.Box2,b=new THREE.Box2,L=new THREE.Box2,Re=new THREE.Color,ge=new THREE.Color,Te=new THREE.Color,Se=new THREE.Vector3,we=new THREE.Vector3,B=new THREE.Vector3,P=new THREE.Matrix3;if(C.setLineDash===undefined){C.setLineDash=function(){}}this.domElement=n;this.autoClear=true;this.sortObjects=true;this.sortElements=true;this.info={render:{vertices:0,faces:0}};this.supportsVertexTextures=function(){};this.setFaceCulling=function(){};this.getContext=function(){return C};this.getContextAttributes=function(){return C.getContextAttributes()};this.getPixelRatio=function(){return r};this.setPixelRatio=function(e){if(e!==undefined)r=e};this.setSize=function(e,i,t){f=e*r;p=i*r;n.width=f;n.height=p;h=Math.floor(f/2);m=Math.floor(p/2);if(t!==false){n.style.width=e+"px";n.style.height=i+"px"}H.min.set(-h,-m);H.max.set(h,m);b.min.set(-h,-m);b.max.set(h,m);a=1;U=0;q=null;J=null;K=null;Q=null;X=null;this.setViewport(0,0,e,i)};this.setViewport=function(e,i,t,n){N=e*r;O=i*r;A=t*r;G=n*r};this.setScissor=function(){};this.setScissorTest=function(){};this.setClearColor=function(e,i){t.set(e);o=i!==undefined?i:1;b.min.set(-h,-m);b.max.set(h,m)};this.setClearColorHex=function(e,i){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead.");this.setClearColor(e,i)};this.getClearColor=function(){return t};this.getClearAlpha=function(){return o};this.getMaxAnisotropy=function(){return 0};this.clear=function(){if(b.isEmpty()===false){b.intersect(H);b.expandByScalar(2);b.min.x=b.min.x+h;b.min.y=-b.min.y+m;b.max.x=b.max.x+h;b.max.y=-b.max.y+m;if(o<1){C.clearRect(b.min.x|0,b.max.y|0,b.max.x-b.min.x|0,b.min.y-b.max.y|0)}if(o>0){j(THREE.NormalBlending);z(1);D("rgba("+Math.floor(t.r*255)+","+Math.floor(t.g*255)+","+Math.floor(t.b*255)+","+o+")");C.fillRect(b.min.x|0,b.max.y|0,b.max.x-b.min.x|0,b.min.y-b.max.y|0)}b.makeEmpty()}};this.clearColor=function(){};this.clearDepth=function(){};this.clearStencil=function(){};this.render=function(e,i){if(i instanceof THREE.Camera===false){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}var t=e.background;if(t&&t.isColor){D("rgb("+Math.floor(t.r*255)+","+Math.floor(t.g*255)+","+Math.floor(t.b*255)+")");C.fillRect(0,0,f,p)}else if(this.autoClear===true){this.clear()}c.info.render.vertices=0;c.info.render.faces=0;C.setTransform(A/f,0,0,-G/p,N,p-O);C.translate(h,m);s=I.projectScene(e,i,this.sortObjects,this.sortElements);F=s.elements;l=s.lights;Y=i;P.getNormalMatrix(i.matrixWorldInverse);He();for(var n=0,r=F.length;n<r;n++){var o=F[n];var a=o.material;if(a===undefined||a.opacity===0)continue;L.makeEmpty();if(o instanceof THREE.RenderableSprite){E=o;E.x*=h;E.y*=m;Me(E,o,a)}else if(o instanceof THREE.RenderableLine){E=o.v1;d=o.v2;E.positionScreen.x*=h;E.positionScreen.y*=m;d.positionScreen.x*=h;d.positionScreen.y*=m;L.setFromPoints([E.positionScreen,d.positionScreen]);if(H.intersectsBox(L)===true){be(E,d,o,a)}}else if(o instanceof THREE.RenderableFace){E=o.v1;d=o.v2;u=o.v3;if(E.positionScreen.z<-1||E.positionScreen.z>1)continue;if(d.positionScreen.z<-1||d.positionScreen.z>1)continue;if(u.positionScreen.z<-1||u.positionScreen.z>1)continue;E.positionScreen.x*=h;E.positionScreen.y*=m;d.positionScreen.x*=h;d.positionScreen.y*=m;u.positionScreen.x*=h;u.positionScreen.y*=m;if(a.overdraw>0){ze(E.positionScreen,d.positionScreen,a.overdraw);ze(d.positionScreen,u.positionScreen,a.overdraw);ze(u.positionScreen,E.positionScreen,a.overdraw)}L.setFromPoints([E.positionScreen,d.positionScreen,u.positionScreen]);if(H.intersectsBox(L)===true){Le(E,d,u,0,1,2,o,a)}}b.union(L)}C.setTransform(1,0,0,1,0,0)};function He(){Re.setRGB(0,0,0);ge.setRGB(0,0,0);Te.setRGB(0,0,0);for(var e=0,i=l.length;e<i;e++){var t=l[e];var n=t.color;if(t instanceof THREE.AmbientLight){Re.add(n)}else if(t instanceof THREE.DirectionalLight){ge.add(n)}else if(t instanceof THREE.PointLight){Te.add(n)}}}function Ce(e,i,t){for(var n=0,r=l.length;n<r;n++){var o=l[n];Ee.copy(o.color);if(o instanceof THREE.DirectionalLight){var a=Se.setFromMatrixPosition(o.matrixWorld).normalize();var s=i.dot(a);if(s<=0)continue;s*=o.intensity;t.add(Ee.multiplyScalar(s))}else if(o instanceof THREE.PointLight){var a=Se.setFromMatrixPosition(o.matrixWorld);var s=i.dot(Se.subVectors(a,e).normalize());if(s<=0)continue;s*=o.distance==0?1:1-Math.min(e.distanceTo(a)/o.distance,1);if(s==0)continue;s*=o.intensity;t.add(Ee.multiplyScalar(s))}}}function Me(e,i,t){z(t.opacity);j(t.blending);var n=i.scale.x*h;var r=i.scale.y*m;var o=.5*Math.sqrt(n*n+r*r);L.min.set(e.x-o,e.y-o);L.max.set(e.x+o,e.y+o);if(t instanceof THREE.SpriteMaterial){var a=t.map;if(a!==null){var s=M[a.id];if(s===undefined||s.version!==a.version){s=Pe(a);M[a.id]=s}if(s.canvas!==undefined){D(s.canvas);var l=a.image;var c=l.width*a.offset.x;var f=l.height*a.offset.y;var p=l.width*a.repeat.x;var E=l.height*a.repeat.y;var d=n/p;var u=r/E;C.save();C.translate(e.x,e.y);if(t.rotation!==0)C.rotate(t.rotation);C.translate(-n/2,-r/2);C.scale(d,u);C.translate(-c,-f);C.fillRect(c,f,p,E);C.restore()}}else{D(t.color.getStyle());C.save();C.translate(e.x,e.y);if(t.rotation!==0)C.rotate(t.rotation);C.scale(n,-r);C.fillRect(-.5,-.5,1,1);C.restore()}}else if(t instanceof THREE.SpriteCanvasMaterial){k(t.color.getStyle());D(t.color.getStyle());C.save();C.translate(e.x,e.y);if(t.rotation!==0)C.rotate(t.rotation);C.scale(n,r);t.program(C);C.restore()}}function be(e,i,t,n){z(n.opacity);j(n.blending);C.beginPath();C.moveTo(e.positionScreen.x,e.positionScreen.y);C.lineTo(i.positionScreen.x,i.positionScreen.y);if(n instanceof THREE.LineBasicMaterial){je(n.linewidth);ke(n.linecap);De(n.linejoin);if(n.vertexColors!==THREE.VertexColors){k(n.color.getStyle())}else{var r=t.vertexColors[0].getStyle();var o=t.vertexColors[1].getStyle();if(r===o){k(r)}else{try{var a=C.createLinearGradient(e.positionScreen.x,e.positionScreen.y,i.positionScreen.x,i.positionScreen.y);a.addColorStop(0,r);a.addColorStop(1,o)}catch(e){a=r}k(a)}}C.stroke();L.expandByScalar(n.linewidth*2)}else if(n instanceof THREE.LineDashedMaterial){je(n.linewidth);ke(n.linecap);De(n.linejoin);k(n.color.getStyle());Fe([n.dashSize,n.gapSize]);C.stroke();L.expandByScalar(n.linewidth*2);Fe([])}}function Le(e,i,t,n,r,o,a,s){c.info.render.vertices+=3;c.info.render.faces++;z(s.opacity);j(s.blending);v=e.positionScreen.x;x=e.positionScreen.y;y=i.positionScreen.x;R=i.positionScreen.y;g=t.positionScreen.x;T=t.positionScreen.y;Be(v,x,y,R,g,T);if((s instanceof THREE.MeshLambertMaterial||s instanceof THREE.MeshPhongMaterial)&&s.map===null){fe.copy(s.color);pe.copy(s.emissive);if(s.vertexColors===THREE.FaceColors){fe.multiply(a.color)}S.copy(Re);we.copy(e.positionWorld).add(i.positionWorld).add(t.positionWorld).divideScalar(3);Ce(we,a.normalModel,S);S.multiply(fe).add(pe);s.wireframe===true?V(S,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):W(S)}else if(s instanceof THREE.MeshBasicMaterial||s instanceof THREE.MeshLambertMaterial||s instanceof THREE.MeshPhongMaterial){if(s.map!==null){var l=s.map.mapping;if(l===THREE.UVMapping){w=a.uvs;Ve(v,x,y,R,g,T,w[n].x,w[n].y,w[r].x,w[r].y,w[o].x,w[o].y,s.map)}}else if(s.envMap!==null){if(s.envMap.mapping===THREE.SphericalReflectionMapping){B.copy(a.vertexNormalsModel[n]).applyMatrix3(P);ue=.5*B.x+.5;he=.5*B.y+.5;B.copy(a.vertexNormalsModel[r]).applyMatrix3(P);me=.5*B.x+.5;ve=.5*B.y+.5;B.copy(a.vertexNormalsModel[o]).applyMatrix3(P);xe=.5*B.x+.5;ye=.5*B.y+.5;Ve(v,x,y,R,g,T,ue,he,me,ve,xe,ye,s.envMap)}}else{S.copy(s.color);if(s.vertexColors===THREE.FaceColors){S.multiply(a.color)}s.wireframe===true?V(S,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):W(S)}}else if(s instanceof THREE.MeshNormalMaterial){B.copy(a.normalModel).applyMatrix3(P);S.setRGB(B.x,B.y,B.z).multiplyScalar(.5).addScalar(.5);s.wireframe===true?V(S,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):W(S)}else{S.setRGB(1,1,1);s.wireframe===true?V(S,s.wireframeLinewidth,s.wireframeLinecap,s.wireframeLinejoin):W(S)}}function Be(e,i,t,n,r,o){C.beginPath();C.moveTo(e,i);C.lineTo(t,n);C.lineTo(r,o);C.closePath()}function V(e,i,t,n){je(i);ke(t);De(n);k(e.getStyle());C.stroke();L.expandByScalar(i*2)}function W(e){D(e.getStyle());C.fill()}function Pe(e){if(e.version===0||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture){return{canvas:undefined,version:e.version}}var i=e.image;if(i.complete===false){return{canvas:undefined,version:0}}var t=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping;var n=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping;var r=e.wrapS===THREE.MirroredRepeatWrapping;var o=e.wrapT===THREE.MirroredRepeatWrapping;var a=document.createElement("canvas");a.width=i.width*(r?2:1);a.height=i.height*(o?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,i.height);s.drawImage(i,0,0);if(r===true){s.setTransform(-1,0,0,-1,i.width,i.height);s.drawImage(i,-i.width,0)}if(o===true){s.setTransform(1,0,0,1,0,0);s.drawImage(i,0,i.height)}if(r===true&&o===true){s.setTransform(-1,0,0,1,i.width,0);s.drawImage(i,-i.width,i.height)}var l="no-repeat";if(t===true&&n===true){l="repeat"}else if(t===true){l="repeat-x"}else if(n===true){l="repeat-y"}var c=C.createPattern(a,l);if(e.onUpdate)e.onUpdate(e);return{canvas:c,version:e.version}}function Ve(e,i,t,n,r,o,a,s,l,c,f,p,E){var d=M[E.id];if(d===undefined||d.version!==E.version){d=Pe(E);M[E.id]=d}if(d.canvas!==undefined){D(d.canvas)}else{D("rgba( 0, 0, 0, 1)");C.fill();return}var u,h,m,v,x,y,R,g,T=E.offset.x/E.repeat.x,S=E.offset.y/E.repeat.y,w=E.image.width*E.repeat.x,H=E.image.height*E.repeat.y;a=(a+T)*w;s=(s+S)*H;l=(l+T)*w;c=(c+S)*H;f=(f+T)*w;p=(p+S)*H;t-=e;n-=i;r-=e;o-=i;l-=a;c-=s;f-=a;p-=s;R=l*p-f*c;if(R===0)return;g=1/R;u=(p*t-c*r)*g;h=(p*n-c*o)*g;m=(l*r-f*t)*g;v=(l*o-f*n)*g;x=e-u*a-m*s;y=i-h*a-v*s;C.save();C.transform(u,h,m,v,x,y);C.fill();C.restore()}function We(e,i,t,n,r,o,a,s,l,c,f,p,E){var d,u,h,m,v,x,y,R,g=E.width-1,T=E.height-1;a*=g;s*=T;l*=g;c*=T;f*=g;p*=T;t-=e;n-=i;r-=e;o-=i;l-=a;c-=s;f-=a;p-=s;y=l*p-f*c;R=1/y;d=(p*t-c*r)*R;u=(p*n-c*o)*R;h=(l*r-f*t)*R;m=(l*o-f*n)*R;v=e-d*a-h*s;x=i-u*a-m*s;C.save();C.transform(d,u,h,m,v,x);C.clip();C.drawImage(E,0,0);C.restore()}function ze(e,i,t){var n=i.x-e.x,r=i.y-e.y,o=n*n+r*r,a;if(o===0)return;a=t/Math.sqrt(o);n*=a;r*=a;i.x+=n;i.y+=r;e.x-=n;e.y-=r}function z(e){if(a!==e){C.globalAlpha=e;a=e}}function j(e){if(U!==e){if(e===THREE.NormalBlending){C.globalCompositeOperation="source-over"}else if(e===THREE.AdditiveBlending){C.globalCompositeOperation="lighter"}else if(e===THREE.SubtractiveBlending){C.globalCompositeOperation="darker"}else if(e===THREE.MultiplyBlending){C.globalCompositeOperation="multiply"}U=e}}function je(e){if(K!==e){C.lineWidth=e;K=e}}function ke(e){if(Q!==e){C.lineCap=e;Q=e}}function De(e){if(X!==e){C.lineJoin=e;X=e}}function k(e){if(q!==e){C.strokeStyle=e;q=e}}function D(e){if(J!==e){C.fillStyle=e;J=e}}function Fe(e){if(i.length!==e.length){C.setLineDash(e);i=e}}};